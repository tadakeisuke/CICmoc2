<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMOTERRAIN - 佐野市感情マップ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cyber-cyan: #06b6d4;
      --cyber-blue: #3b82f6;
      --cyber-purple: #8b5cf6;
      --sidebar-bg: rgba(26,26,46,0.95);
      --panel-bg: rgba(26,26,46,0.95);
      --border-cyan: rgba(6,182,212,0.3);
      --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-mono);
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .header {
      border-bottom: 1px solid var(--border-cyan);
      padding-bottom: 15px;
      margin-bottom: 10px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .logo-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; font-size: 20px;
    }
    .logo-text {
      font-size: 18px; font-weight: bold;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue), var(--cyber-purple));
      background-clip: text; -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { font-size: 12px; color: var(--cyber-cyan); }
    .timestamp { font-size: 11px; color: #9ca3af; }
    .section-title {
      font-size: 14px; font-weight: bold; color: var(--cyber-cyan);
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .emotion-filters { display: flex; flex-direction: column; gap: 8px; }
    .emotion-btn {
      padding: 10px 12px;
      border: 1px solid var(--border-cyan);
      background: rgba(55,65,81,0.5);
      color: var(--cyber-cyan);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 10px;
      font-size: 12px; font-weight: bold;
    }
    .emotion-btn:hover { background: rgba(75,85,99,0.5); border-color: rgba(6,182,212,0.5);}
    .emotion-btn.active {
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      color: #222; border-color: var(--cyber-cyan);
    }
    .layer-controls, .stats-panel {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .control-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .control-label { font-size: 11px; color: #9ca3af; }
    .toggle-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-cyan);
      background: rgba(75,85,99,0.5);
      color: #9ca3af;
      border-radius: 4px;
      cursor: pointer; font-size: 10px; transition: all 0.2s;
    }
    .toggle-btn.active { background: rgba(6,182,212,0.2); color: var(--cyber-cyan);}
    .opacity-slider {
      width: 100%; height: 4px; background: #374151;
      border-radius: 2px; outline: none; cursor: pointer;
    }
    .stat-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; font-size: 11px;
    }
    .stat-label { color: #9ca3af; }
    .stat-value { color: var(--cyber-cyan); font-weight: bold; }
    .emotion-indicator {
      width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; display: inline-block;
    }
    .map-container {
      flex: 1; position: relative;
      min-width: 0;
    }
    #map { height: 100%; width: 100%; }
    .leaflet-popup-content-wrapper {
      background: var(--panel-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
    }
    .leaflet-popup-content {
      color: #fff; font-family: var(--font-mono); margin: 15px;
    }
    .leaflet-popup-tip {
      background: var(--panel-bg);
      border: 1px solid var(--border-cyan);
    }
    .popup-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .popup-section { margin-bottom: 12px;}
    .popup-label { font-size: 11px; color: #9ca3af; margin-bottom: 5px;}
    .popup-value { font-size: 12px; color: #fff; font-weight: bold;}
    .emotion-score {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 5px; font-size: 11px;
    }
    .feature-tag {
      display: inline-block;
      background: rgba(6,182,212,0.2);
      color: var(--cyber-cyan);
      padding: 2px 6px; border-radius: 4px; margin-right: 4px;
      font-size: 11px;
    }
    .details-panel {
      width: 340px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex; flex-direction: column; gap: 16px;
    }
    .details-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .no-selection {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: #9ca3af; gap: 10px;
    }
    .no-selection-icon { font-size: 32px; color: var(--cyber-cyan);}
    .no-selection-text { font-size: 13px;}
    .info-box {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .info-title { font-size: 13px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 8px;}
    .info-item { font-size: 12px; margin-bottom: 6px;}
    @media (max-width: 1024px) {
      .sidebar { width: 220px; padding: 10px;}
      .details-panel { width: 220px; padding: 10px;}
    }
    @media (max-width: 768px) {
      .container { flex-direction: column;}
      .sidebar, .details-panel { width: 100vw; min-width: 0; border: none; border-bottom: 1px solid var(--border-cyan);}
      .sidebar { order: 1;}
      .map-container { order: 2; min-height: 300px;}
      .details-panel { order: 3;}
    }
    @media (max-width: 480px) {
      .sidebar, .details-panel { padding: 6px;}
      .header { padding-bottom: 8px;}
      .logo-text { font-size: 15px;}
      .details-title { font-size: 13px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="header">
        <div class="logo">
          <div class="logo-icon"><i class="fa-solid fa-brain"></i></div>
          <div class="logo-text">EMOTERRAIN</div>
        </div>
        <div class="subtitle">佐野市感情マップ</div>
        <div class="timestamp" id="timestamp"></div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-info-circle"></i> 区画単位</div>
        <div style="font-size:11px; color:#9ca3af; margin-bottom:15px; line-height:1.4;">
          佐野市の町・字（あざ）単位で区画分けした感情ヒートマップ。各区画の行政境界に基づいて感情データを可視化しています。
        </div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-filter"></i> 感情フィルター</div>
        <div class="emotion-filters" id="emotion-filters"></div>
      </div>
      <div class="layer-controls">
        <div class="control-item">
          <span class="control-label">表示モード</span>
          <select id="display-mode" style="padding:4px 8px;border:1px solid rgba(6,182,212,0.3);background:rgba(75,85,99,0.5);color:#06b6d4;border-radius:4px;font-size:11px;">
            <option value="boundary">境界線表示</option>
            <option value="heatmap">ヒートマップ</option>
          </select>
        </div>
        <div class="control-item">
          <span class="control-label">感情レイヤー</span>
          <button class="toggle-btn active" id="layer-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">ラベル表示</span>
          <button class="toggle-btn active" id="label-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">透明度</span>
        </div>
        <input type="range" min="0.2" max="1" step="0.01" value="0.7" class="opacity-slider" id="opacity-slider">
      </div>
      <div class="stats-panel" id="stats-panel"></div>
    </div>
    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      <div style="position:absolute;bottom:8px;right:12px;z-index:999;font-size:11px;background:rgba(26,26,46,0.7);padding:4px 10px;border-radius:6px;">
        © <a href="https://openstreetmap.org" target="_blank" style="color:#06b6d4;text-decoration:underline;">OpenStreetMap</a> contributors
      </div>
    </div>
    <!-- Right Details Panel -->
    <div class="details-panel" id="details-panel"></div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // 感情カラー（強度別）
    const emotionColors = {
      joy: {
        low: (opacity) => `rgba(34,197,94,${opacity * 0.4})`,      // 薄い緑
        medium: (opacity) => `rgba(34,197,94,${opacity * 0.7})`,   // 中緑
        high: (opacity) => `rgba(34,197,94,${opacity})`,           // 濃い緑
        veryHigh: (opacity) => `rgba(21,128,61,${opacity})`        // 非常に濃い緑
      },
      calm: {
        low: (opacity) => `rgba(59,130,246,${opacity * 0.4})`,     // 薄い青
        medium: (opacity) => `rgba(59,130,246,${opacity * 0.7})`,  // 中青
        high: (opacity) => `rgba(59,130,246,${opacity})`,          // 濃い青
        veryHigh: (opacity) => `rgba(37,99,235,${opacity})`        // 非常に濃い青
      },
      excitement: {
        low: (opacity) => `rgba(245,158,11,${opacity * 0.4})`,     // 薄いオレンジ
        medium: (opacity) => `rgba(245,158,11,${opacity * 0.7})`,  // 中オレンジ
        high: (opacity) => `rgba(245,158,11,${opacity})`,          // 濃いオレンジ
        veryHigh: (opacity) => `rgba(217,119,6,${opacity})`        // 非常に濃いオレンジ
      },
      stress: {
        low: (opacity) => `rgba(239,68,68,${opacity * 0.4})`,      // 薄い赤
        medium: (opacity) => `rgba(239,68,68,${opacity * 0.7})`,   // 中赤
        high: (opacity) => `rgba(239,68,68,${opacity})`,           // 濃い赤
        veryHigh: (opacity) => `rgba(185,28,28,${opacity})`        // 非常に濃い赤
      }
    };
    // 佐野市町・字単位の詳細GeoJSON（実際の行政区画に基づく）
    const sanoAzaGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        // 佐野駅周辺エリア（商業・中心部）
        {
          "type": "Feature",
          "properties": {
            "id": "honcho1",
            "name": "本町一丁目",
            "type": "商業地域",
            "population": 1200,
            "area": 0.3,
            "density": 4000,
            "emotions": { "joy": 75, "calm": 50, "excitement": 80, "stress": 45 },
            "incidents": { "total": 15, "joy": 9, "calm": 2, "excitement": 3, "stress": 1 },
            "features": ["佐野市役所", "佐野駅", "商店街", "銀行"],
            "analysis": {
              "primary": "excitement",
              "intensity": "非常に高",
              "factors": ["駅前立地", "商業集積", "行政中心", "人流多"],
              "recommendations": ["歩行者空間整備", "治安対策", "騒音軽減"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5820,36.3155],[139.5835,36.3155],[139.5835,36.3145],[139.5820,36.3145],[139.5820,36.3155]]]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "id": "honcho2",
            "name": "本町二丁目",
            "type": "住商混在地域",
            "population": 950,
            "area": 0.25,
            "density": 3800,
            "emotions": { "joy": 65, "calm": 60, "excitement": 55, "stress": 30 },
            "incidents": { "total": 10, "joy": 6, "calm": 2, "excitement": 1, "stress": 1 },
            "features": ["スーパー", "小学校", "郵便局", "公民館"],
            "analysis": {
              "primary": "joy",
              "intensity": "中",
              "factors": ["学校近接", "生活利便", "住環境良好"],
              "recommendations": ["子育て支援", "防犯強化", "交通安全"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5835,36.3155],[139.5850,36.3155],[139.5850,36.3145],[139.5835,36.3145],[139.5835,36.3155]]]
          }
        },
        // 住宅地エリア
        {
          "type": "Feature",
          "properties": {
            "id": "takahagi",
            "name": "高萩町",
            "type": "住宅地域",
            "population": 1800,
            "area": 0.8,
            "density": 2250,
            "emotions": { "joy": 70, "calm": 75, "excitement": 35, "stress": 20 },
            "incidents": { "total": 8, "joy": 5, "calm": 2, "excitement": 0, "stress": 1 },
            "features": ["住宅団地", "公園", "コミュニティセンター", "保育園"],
            "analysis": {
              "primary": "calm",
              "intensity": "高",
              "factors": ["閑静住宅地", "緑地豊富", "子育て世帯多", "治安良好"],
              "recommendations": ["公園整備", "高齢者対策", "コミュニティ強化"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5815,36.3140],[139.5835,36.3140],[139.5835,36.3125],[139.5815,36.3125],[139.5815,36.3140]]]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "id": "sumiyoshi",
            "name": "住吉町",
            "type": "住宅地域",
            "population": 1100,
            "area": 0.6,
            "density": 1833,
            "emotions": { "joy": 60, "calm": 80, "excitement": 25, "stress": 15 },
            "incidents": { "total": 5, "joy": 2, "calm": 2, "excitement": 0, "stress": 1 },
            "features": ["住吉神社", "病院", "老人ホーム", "薬局"],
            "analysis": {
              "primary": "calm",
              "intensity": "非常に高",
              "factors": ["伝統的住宅地", "医療充実", "高齢者多", "静寂環境"],
              "recommendations": ["医療連携強化", "バリアフリー化", "防災対策"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5835,36.3140],[139.5855,36.3140],[139.5855,36.3125],[139.5835,36.3125],[139.5835,36.3140]]]
          }
        },
        // 新興住宅地
        {
          "type": "Feature",
          "properties": {
            "id": "wakaba1",
            "name": "若葉町一丁目",
            "type": "新興住宅地域",
            "population": 1350,
            "area": 0.45,
            "density": 3000,
            "emotions": { "joy": 85, "calm": 55, "excitement": 60, "stress": 25 },
            "incidents": { "total": 12, "joy": 8, "calm": 2, "excitement": 1, "stress": 1 },
            "features": ["新築住宅群", "幼稚園", "公園", "児童館"],
            "analysis": {
              "primary": "joy",
              "intensity": "非常に高",
              "factors": ["新興開発", "若い世帯", "子育て環境", "近代設備"],
              "recommendations": ["遊具充実", "交通安全", "コミュニティ形成"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5810,36.3120],[139.5830,36.3120],[139.5830,36.3105],[139.5810,36.3105],[139.5810,36.3120]]]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "id": "wakaba2",
            "name": "若葉町二丁目",
            "type": "新興住宅地域",
            "population": 900,
            "area": 0.35,
            "density": 2571,
            "emotions": { "joy": 80, "calm": 60, "excitement": 45, "stress": 20 },
            "incidents": { "total": 7, "joy": 5, "calm": 1, "excitement": 1, "stress": 0 },
            "features": ["分譲住宅", "集会所", "小公園"],
            "analysis": {
              "primary": "joy",
              "intensity": "高",
              "factors": ["計画的開発", "家族世帯", "新しい街"],
              "recommendations": ["インフラ整備", "防犯対策", "緑化推進"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5830,36.3120],[139.5850,36.3120],[139.5850,36.3105],[139.5830,36.3105],[139.5830,36.3120]]]
          }
        },
        // 歴史・文化エリア
        {
          "type": "Feature",
          "properties": {
            "id": "shiroyama",
            "name": "城山町",
            "type": "歴史文化地域",
            "population": 600,
            "area": 0.7,
            "density": 857,
            "emotions": { "joy": 55, "calm": 70, "excitement": 65, "stress": 20 },
            "incidents": { "total": 18, "joy": 6, "calm": 4, "excitement": 7, "stress": 1 },
            "features": ["佐野城跡", "歴史資料館", "観光案内所", "土産店"],
            "analysis": {
              "primary": "excitement",
              "intensity": "中",
              "factors": ["歴史的価値", "観光地", "文化イベント", "景観良好"],
              "recommendations": ["観光振興", "景観保護", "案内充実", "イベント拡充"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5835,36.3120],[139.5860,36.3120],[139.5860,36.3100],[139.5835,36.3100],[139.5835,36.3120]]]
          }
        },
        // 商業・交通拠点
        {
          "type": "Feature",
          "properties": {
            "id": "ekimae",
            "name": "駅前町",
            "type": "商業地域",
            "population": 1300,
            "area": 0.2,
            "density": 6500,
            "emotions": { "joy": 50, "calm": 35, "excitement": 90, "stress": 55 },
            "incidents": { "total": 28, "joy": 4, "calm": 2, "excitement": 18, "stress": 4 },
            "features": ["JR佐野駅", "商店街", "飲食店", "コンビニ", "タクシー乗り場"],
            "analysis": {
              "primary": "excitement",
              "intensity": "非常に高",
              "factors": ["交通拠点", "商業集積", "昼夜人口差大", "騒音・混雑"],
              "recommendations": ["歩行者優先", "治安強化", "騒音対策", "清掃強化"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5825,36.3100],[139.5840,36.3100],[139.5840,36.3085],[139.5825,36.3085],[139.5825,36.3100]]]
          }
        },
        // 工業・物流エリア
        {
          "type": "Feature",
          "properties": {
            "id": "kougyou1",
            "name": "工業団地一区",
            "type": "工業地域",
            "population": 400,
            "area": 1.2,
            "density": 333,
            "emotions": { "joy": 40, "calm": 45, "excitement": 70, "stress": 60 },
            "incidents": { "total": 25, "joy": 2, "calm": 3, "excitement": 12, "stress": 8 },
            "features": ["製造工場", "物流センター", "事務所", "駐車場"],
            "analysis": {
              "primary": "excitement",
              "intensity": "高",
              "factors": ["24時間稼働", "大型車両", "騒音", "活発な産業"],
              "recommendations": ["騒音対策", "交通整理", "環境保全", "労働環境改善"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5840,36.3100],[139.5870,36.3100],[139.5870,36.3075],[139.5840,36.3075],[139.5840,36.3100]]]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "id": "kougyou2",
            "name": "工業団地二区",
            "type": "工業地域",
            "population": 300,
            "area": 1.0,
            "density": 300,
            "emotions": { "joy": 35, "calm": 40, "excitement": 60, "stress": 70 },
            "incidents": { "total": 22, "joy": 1, "calm": 2, "excitement": 8, "stress": 11 },
            "features": ["重工業", "倉庫群", "トラック駐車場", "廃棄物処理"],
            "analysis": {
              "primary": "stress",
              "intensity": "高",
              "factors": ["重工業", "環境負荷", "交通渋滞", "大気・騒音"],
              "recommendations": ["環境改善", "緑地整備", "交通規制", "住民配慮"]
            }
          },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[139.5815,36.3085],[139.5845,36.3085],[139.5845,36.3065],[139.5815,36.3065],[139.5815,36.3085]]]
          }
        }
      ]
    };

    // グローバル変数
    let map, emotionLayer, selectedEmotion = 'all', selectedArea = null, showEmotionLayer = true, showLabels = true, layerOpacity = 0.7, displayMode = 'boundary';

    // 地図初期化
    function initializeMap() {
      map = L.map('map', {
        center: [36.3145, 139.5834],
        zoom: 15,
        minZoom: 12,
        maxZoom: 18,
        zoomControl: true,
        attributionControl: false
      });
      // OSMタイル
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
      }).addTo(map);
      loadEmotionData();
    }

    // 感情レイヤー描画
    function loadEmotionData() {
      if (emotionLayer) { map.removeLayer(emotionLayer); }
      emotionLayer = L.geoJSON(sanoAzaGeoJSON, {
        style: feature => getEmotionStyle(feature),
        onEachFeature: (feature, layer) => {
          layer.on({
            mouseover: function(e) {
              this.setStyle({ weight: 3, color: '#fff', dashArray: '2', fillOpacity: Math.min(layerOpacity+0.15,1) });
              if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { this.bringToFront(); }
            },
            mouseout: function(e) {
              emotionLayer.resetStyle(e.target);
            },
            click: function(e) {
              selectArea(feature);
              map.fitBounds(layer.getBounds(), { maxZoom: 16 });
            }
          });
          layer.bindPopup(createPopupContent(feature), { closeButton: true, minWidth: 220 });
        },
        filter: feature => {
          if (selectedEmotion === 'all') return true;
          return feature.properties.analysis.primary === selectedEmotion;
        }
      }).addTo(map);
      if (showLabels) addLabels();
    }

    // ラベル描画
    function addLabels() {
      sanoAzaGeoJSON.features.forEach(f => {
        const center = getPolygonCenter(f.geometry.coordinates[0]);
        L.marker([center[1], center[0]], {
          icon: L.divIcon({
            className: 'custom-label',
            html: `<span style="background:rgba(6,182,212,0.7);color:#fff;padding:2px 8px;border-radius:6px;font-size:11px;">${f.properties.name}</span>`,
            iconSize: [60, 18],
            iconAnchor: [30, 9]
          })
        }).addTo(map);
      });
    }

    // ポリゴン中心計算
    function getPolygonCenter(coords) {
      let x=0, y=0, n=coords.length;
      coords.forEach(c => { x+=c[0]; y+=c[1]; });
      return [x/n, y/n];
    }

    // ポリゴンスタイル（境界線表示・ヒートマップ対応）
    function getEmotionStyle(feature) {
      const emotion = feature.properties.analysis.primary;
      const intensity = feature.properties.analysis.intensity;
      const score = feature.properties.emotions[emotion];
      
      // 強度に応じた色選択
      let colorLevel;
      switch(intensity) {
        case '低': colorLevel = 'low'; break;
        case '中': colorLevel = 'medium'; break;
        case '高': colorLevel = 'high'; break;
        case '非常に高': colorLevel = 'veryHigh'; break;
        default: colorLevel = 'medium';
      }
      
      if (displayMode === 'heatmap') {
        // ヒートマップモード：境界線なし、より強い色塗り
        return {
          color: 'transparent',
          weight: 0,
          opacity: 0,
          fillColor: emotionColors[emotion][colorLevel](Math.min(layerOpacity + 0.3, 1)),
          fillOpacity: Math.min(layerOpacity + 0.3, 1),
          dashArray: null
        };
      } else {
        // 境界線モード：通常表示
        return {
          color: '#333',
          weight: 1.5,
          opacity: 0.8,
          fillColor: emotionColors[emotion][colorLevel](layerOpacity),
          fillOpacity: layerOpacity,
          dashArray: null
        };
      }
    }

    // ポップアップ内容（詳細情報）
    function createPopupContent(feature) {
      const p = feature.properties;
      const primaryEmotion = p.analysis.primary;
      const intensity = p.analysis.intensity;
      
      return `
        <div class="popup-title">${p.name} <span style="color:#9ca3af;">(${p.type})</span></div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-chart-simple"></i> 基本情報</div>
          <div class="popup-value">
            人口: <strong>${p.population}人</strong> | 面積: <strong>${p.area}km²</strong><br>
            人口密度: <strong>${p.density}人/km²</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-face-smile"></i> 感情スコア</div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}; color:${k === primaryEmotion ? '#06b6d4' : '#fff'}">${v}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-exclamation-triangle"></i> 感情分析</div>
          <div class="popup-value">
            主要感情: <strong style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])}">${capitalize(primaryEmotion)} (${intensity})</strong><br>
            事案総数: <strong>${p.incidents.total}件</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-location-dot"></i> 主要施設</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
      `;
    }
    
    // ポップアップ用色取得
    function getEmotionColorForPopup(emotion, score) {
      if (score >= 70) return emotionColors[emotion].veryHigh(1);
      if (score >= 60) return emotionColors[emotion].high(1);
      if (score >= 40) return emotionColors[emotion].medium(1);
      return emotionColors[emotion].low(1);
    }

    // 詳細パネル更新（警視庁マップ風）
    function updateDetailsPanel() {
      const panel = document.getElementById('details-panel');
      if (!selectedArea) {
        panel.innerHTML = `
          <div class="no-selection">
            <div class="no-selection-icon"><i class="fa-solid fa-map"></i></div>
            <div class="no-selection-text">区画を選択すると詳細分析が表示されます</div>
          </div>
        `;
        return;
      }
      const p = selectedArea.properties;
      const primaryEmotion = p.analysis.primary;
      
      panel.innerHTML = `
        <div class="details-title">${p.name}</div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-info-circle"></i> 区画情報</div>
          <div class="info-item">種別: <strong>${p.type}</strong></div>
          <div class="info-item">人口: <strong>${p.population}人</strong></div>
          <div class="info-item">面積: <strong>${p.area}km²</strong></div>
          <div class="info-item">人口密度: <strong>${p.density}人/km²</strong></div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-face-smile"></i> 感情分析</div>
          <div class="info-item" style="margin-bottom:10px;">
            主要感情: <span style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])};font-weight:bold;font-size:14px;">
              ${capitalize(primaryEmotion)} (${p.analysis.intensity})
            </span>
          </div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score" style="margin-bottom:6px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}">${v}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-chart-bar"></i> 事案統計</div>
          <div class="info-item">総事案数: <strong style="color:#06b6d4;">${p.incidents.total}件</strong></div>
          ${Object.entries(p.incidents).filter(([k]) => k !== 'total').map(([k,v])=>`
            <div class="info-item" style="font-size:11px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, 50)}"></span>
              ${capitalize(k)}: ${v}件
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-location-dot"></i> 主要施設</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-search"></i> 要因分析</div>
          <div class="info-item">要因: ${p.analysis.factors.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-lightbulb"></i> 改善提案</div>
          <div>${p.analysis.recommendations.map(r=>`<span class="feature-tag">${r}</span>`).join('')}</div>
        </div>
      `;
    }

    // エリア選択
    function selectArea(feature) {
      selectedArea = feature;
      updateDetailsPanel();
    }

    // 統計パネル更新（詳細統計）
    function updateStatistics() {
      const statsPanel = document.getElementById('stats-panel');
      const filtered = sanoAzaGeoJSON.features.filter(f => {
        if (selectedEmotion === 'all') return true;
        return f.properties.analysis.primary === selectedEmotion;
      });
      
      const totalPop = filtered.reduce((sum,f)=>sum+f.properties.population,0);
      const totalArea = filtered.reduce((sum,f)=>sum+f.properties.area,0);
      const totalIncidents = filtered.reduce((sum,f)=>sum+f.properties.incidents.total,0);
      const avgDensity = filtered.length ? Math.round(totalPop / totalArea) : 0;
      
      const avgEmotions = { joy:0, calm:0, excitement:0, stress:0 };
      filtered.forEach(f=>{
        Object.keys(avgEmotions).forEach(k=>{
          avgEmotions[k] += f.properties.emotions[k];
        });
      });
      Object.keys(avgEmotions).forEach(k=>{
        avgEmotions[k] = filtered.length ? Math.round(avgEmotions[k]/filtered.length) : 0;
      });
      
      // 強度別集計
      const intensityCount = { '低': 0, '中': 0, '高': 0, '非常に高': 0 };
      filtered.forEach(f => {
        const intensity = f.properties.analysis.intensity;
        if (intensityCount[intensity] !== undefined) {
          intensityCount[intensity]++;
        }
      });
      
      statsPanel.innerHTML = `
        <div class="section-title"><i class="fa-solid fa-chart-pie"></i> 統計情報</div>
        
        <div class="stat-item"><span class="stat-label">区画数</span><span class="stat-value">${filtered.length}</span></div>
        <div class="stat-item"><span class="stat-label">総人口</span><span class="stat-value">${totalPop.toLocaleString()}人</span></div>
        <div class="stat-item"><span class="stat-label">総面積</span><span class="stat-value">${totalArea}km²</span></div>
        <div class="stat-item"><span class="stat-label">平均密度</span><span class="stat-value">${avgDensity.toLocaleString()}人/km²</span></div>
        <div class="stat-item"><span class="stat-label">総事案数</span><span class="stat-value" style="color:#f59e0b;">${totalIncidents}件</span></div>
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-face-smile"></i> 感情スコア平均
        </div>
        ${Object.entries(avgEmotions).map(([k,v])=>`
          <div class="stat-item">
            <span class="stat-label"><span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>${capitalize(k)}</span>
            <span class="stat-value">${v}</span>
          </div>
        `).join('')}
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-signal"></i> 強度分布
        </div>
        ${Object.entries(intensityCount).map(([intensity, count])=>`
          <div class="stat-item">
            <span class="stat-label">${intensity}</span>
            <span class="stat-value">${count}区画</span>
          </div>
        `).join('')}
      `;
    }

    // 感情フィルター初期化（更新版）
    function initializeControls() {
      const filterDiv = document.getElementById('emotion-filters');
      const emotions = [
        { key:'all', label:'全表示', icon:'fa-layer-group' },
        { key:'joy', label:'Joy (喜び)', icon:'fa-face-smile' },
        { key:'calm', label:'Calm (平静)', icon:'fa-face-meh' },
        { key:'excitement', label:'Excitement (興奮)', icon:'fa-bolt' },
        { key:'stress', label:'Stress (ストレス)', icon:'fa-face-frown' }
      ];
      
      filterDiv.innerHTML = '';
      emotions.forEach(e=>{
        const btn = document.createElement('button');
        btn.className = 'emotion-btn' + (selectedEmotion===e.key?' active':'');
        btn.innerHTML = `<i class="fa-solid ${e.icon}"></i> ${e.label}`;
        btn.onclick = ()=>{
          selectedEmotion = e.key;
          // すべてのボタンのactiveクラスを削除
          filterDiv.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
          // クリックされたボタンにactiveクラスを追加
          btn.classList.add('active');
          loadEmotionData();
          updateStatistics();
        };
        filterDiv.appendChild(btn);
      });
      
      // 表示モード切り替え
      document.getElementById('display-mode').onchange = function() {
        displayMode = this.value;
        loadEmotionData();
      };
      
      // レイヤーON/OFF
      document.getElementById('layer-toggle').onclick = function() {
        showEmotionLayer = !showEmotionLayer;
        this.classList.toggle('active', showEmotionLayer);
        this.textContent = showEmotionLayer ? 'ON' : 'OFF';
        if (showEmotionLayer) loadEmotionData();
        else if (emotionLayer) map.removeLayer(emotionLayer);
      };
      
      // ラベルON/OFF
      document.getElementById('label-toggle').onclick = function() {
        showLabels = !showLabels;
        this.classList.toggle('active', showLabels);
        this.textContent = showLabels ? 'ON' : 'OFF';
        loadEmotionData();
      };
      
      // 透明度スライダー
      document.getElementById('opacity-slider').oninput = function() {
        layerOpacity = parseFloat(this.value);
        loadEmotionData();
      };
    }

    // タイムスタンプ更新
    function updateTimestamp() {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
      const h = now.getHours(), min = now.getMinutes(), s = now.getSeconds();
      document.getElementById('timestamp').textContent =
        `${y}年${m}月${d}日 ${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // 文字列先頭大文字
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      initializeControls();
      updateStatistics();
      updateDetailsPanel();
      setInterval(updateTimestamp, 1000);
    });
  </script>
</body>
</html>