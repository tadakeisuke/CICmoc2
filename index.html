<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMOTERRAIN - 徳島市感情マップ（阿波踊り演舞場エリア）</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cyber-cyan: #06b6d4;
      --cyber-blue: #3b82f6;
      --cyber-purple: #8b5cf6;
      --sidebar-bg: rgba(26,26,46,0.95);
      --panel-bg: rgba(26,26,46,0.95);
      --border-cyan: rgba(6,182,212,0.3);
      --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-mono);
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .header {
      border-bottom: 1px solid var(--border-cyan);
      padding-bottom: 15px;
      margin-bottom: 10px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .logo-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; font-size: 20px;
    }
    .logo-text {
      font-size: 18px; font-weight: bold;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue), var(--cyber-purple));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { font-size: 12px; color: var(--cyber-cyan); }
    .timestamp { font-size: 11px; color: #9ca3af; }
    .section-title {
      font-size: 14px; font-weight: bold; color: var(--cyber-cyan);
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .emotion-filters { display: flex; flex-direction: column; gap: 8px; }
    .emotion-btn {
      padding: 10px 12px;
      border: 1px solid var(--border-cyan);
      background: rgba(55,65,81,0.5);
      color: var(--cyber-cyan);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 10px;
      font-size: 12px; font-weight: bold;
    }
    .emotion-btn:hover { background: rgba(75,85,99,0.5); border-color: rgba(6,182,212,0.5);}
    .emotion-btn.active {
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      color: #222; border-color: var(--cyber-cyan);
    }
    .layer-controls, .stats-panel {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .control-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .control-label { font-size: 11px; color: #9ca3af; }
    .toggle-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-cyan);
      background: rgba(75,85,99,0.5);
      color: #9ca3af;
      border-radius: 4px;
      cursor: pointer; font-size: 10px; transition: all 0.2s;
    }
    .toggle-btn.active { background: rgba(6,182,212,0.2); color: var(--cyber-cyan);}
    .opacity-slider {
      width: 100%; height: 4px; background: #374151;
      border-radius: 2px; outline: none; cursor: pointer;
    }
    .stat-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; font-size: 11px;
    }
    .stat-label { color: #9ca3af; }
    .stat-value { color: var(--cyber-cyan); font-weight: bold; }
    .emotion-indicator {
      width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; display: inline-block;
    }
    .map-container {
      flex: 1; position: relative;
      min-width: 0;
    }
    
    /* 地図直接色塗り用CSS */
    .leaflet-interactive {
      mix-blend-mode: multiply;  /* 地図タイルとの色合成 */
    }
    
    .leaflet-overlay-pane svg {
      pointer-events: auto;
    }
    
    /* 地図一体化用の境界線スタイル - より精密で自然な表現 */
    path.leaflet-interactive {
      stroke-linecap: round;
      stroke-linejoin: round;
      vector-effect: non-scaling-stroke; /* ズーム時の線幅を一定に保持 */
    }
    
    /* OpenStreetMapとの境界線調和 */
    .leaflet-overlay-pane path {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); /* 微細な影効果 */
    }
    
    #map { height: 100%; width: 100%; }
    .leaflet-popup-content-wrapper {
      background: var(--panel-bg);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
    }
    .leaflet-popup-content {
      color: #fff; font-family: var(--font-mono); margin: 15px;
    }
    .leaflet-popup-tip {
      background: var(--panel-bg);
      border: 1px solid var(--border-cyan);
    }
    .popup-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .popup-section { margin-bottom: 12px;}
    .popup-label { font-size: 11px; color: #9ca3af; margin-bottom: 5px;}
    .popup-value { font-size: 12px; color: #fff; font-weight: bold;}
    .emotion-score {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 5px; font-size: 11px;
    }
    .feature-tag {
      display: inline-block;
      background: rgba(6,182,212,0.2);
      color: var(--cyber-cyan);
      padding: 2px 6px; border-radius: 4px; margin-right: 4px;
      font-size: 11px;
    }
    .details-panel {
      width: 340px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex; flex-direction: column; gap: 16px;
    }
    .details-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .no-selection {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: #9ca3af; gap: 10px;
    }
    .no-selection-icon { font-size: 32px; color: var(--cyber-cyan);}
    .no-selection-text { font-size: 13px;}
    .info-box {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .info-title { font-size: 13px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 8px;}
    .info-item { font-size: 12px; margin-bottom: 6px;}
    @media (max-width: 1024px) {
      .sidebar { width: 220px; padding: 10px;}
      .details-panel { width: 220px; padding: 10px;}
    }
    @media (max-width: 768px) {
      .container { flex-direction: column;}
      .sidebar, .details-panel { width: 100vw; min-width: 0; border: none; border-bottom: 1px solid var(--border-cyan);}
      .sidebar { order: 1;}
      .map-container { order: 2; min-height: 300px;}
      .details-panel { order: 3;}
    }
    @media (max-width: 480px) {
      .sidebar, .details-panel { padding: 6px;}
      .header { padding-bottom: 8px;}
      .logo-text { font-size: 15px;}
      .details-title { font-size: 13px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="header">
        <div class="logo">
          <div class="logo-icon"><i class="fa-solid fa-brain"></i></div>
          <div class="logo-text">EMOTERRAIN</div>
        </div>
        <div class="subtitle">徳島市感情マップ - 阿波踊りエリア</div>
        <div class="timestamp" id="timestamp"></div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-info-circle"></i> データ仕様</div>
        <div style="font-size:11px; color:#9ca3af; margin-bottom:15px; line-height:1.4;">
          <strong>国土数値情報準拠</strong><br>
          実際の行政区画境界に基づく町・字単位の感情ヒートマップ。OpenStreetMapの地図データと境界線が一致した精密な区画分析。
        </div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-filter"></i> 感情フィルター</div>
        <div class="emotion-filters" id="emotion-filters"></div>
      </div>
      <div class="layer-controls">
        <div class="control-item">
          <span class="control-label">表示モード</span>
          <select id="display-mode" title="表示モード選択" style="padding:4px 8px;border:1px solid rgba(6,182,212,0.3);background:rgba(75,85,99,0.5);color:#06b6d4;border-radius:4px;font-size:11px;">
            <option value="boundary">境界線表示</option>
            <option value="heatmap">ヒートマップ</option>
          </select>
        </div>
        <div class="control-item">
          <span class="control-label">感情レイヤー</span>
          <button class="toggle-btn active" id="layer-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">ラベル表示</span>
          <button class="toggle-btn active" id="label-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">透明度</span>
        </div>
        <input type="range" min="0.2" max="1" step="0.01" value="0.7" class="opacity-slider" id="opacity-slider" title="透明度調整">
      </div>
      <div class="stats-panel" id="stats-panel"></div>
    </div>
    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      <div style="position:absolute;bottom:8px;right:12px;z-index:999;font-size:11px;background:rgba(26,26,46,0.7);padding:4px 10px;border-radius:6px;">
        © <a href="https://openstreetmap.org" target="_blank" rel="noopener" style="color:#06b6d4;text-decoration:underline;">OpenStreetMap</a> contributors
      </div>
    </div>
    <!-- Right Details Panel -->
    <div class="details-panel" id="details-panel"></div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // 感情カラー（強度別）
    const emotionColors = {
      joy: {
        low: (opacity) => `rgba(34,197,94,${opacity * 0.4})`,      // 薄い緑
        medium: (opacity) => `rgba(34,197,94,${opacity * 0.7})`,   // 中緑
        high: (opacity) => `rgba(34,197,94,${opacity})`,           // 濃い緑
        veryHigh: (opacity) => `rgba(21,128,61,${opacity})`        // 非常に濃い緑
      },
      calm: {
        low: (opacity) => `rgba(59,130,246,${opacity * 0.4})`,     // 薄い青
        medium: (opacity) => `rgba(59,130,246,${opacity * 0.7})`,  // 中青
        high: (opacity) => `rgba(59,130,246,${opacity})`,          // 濃い青
        veryHigh: (opacity) => `rgba(37,99,235,${opacity})`        // 非常に濃い青
      },
      excitement: {
        low: (opacity) => `rgba(245,158,11,${opacity * 0.4})`,     // 薄いオレンジ
        medium: (opacity) => `rgba(245,158,11,${opacity * 0.7})`,  // 中オレンジ
        high: (opacity) => `rgba(245,158,11,${opacity})`,          // 濃いオレンジ
        veryHigh: (opacity) => `rgba(217,119,6,${opacity})`        // 非常に濃いオレンジ
      },
      stress: {
        low: (opacity) => `rgba(239,68,68,${opacity * 0.4})`,      // 薄い赤
        medium: (opacity) => `rgba(239,68,68,${opacity * 0.7})`,   // 中赤
        high: (opacity) => `rgba(239,68,68,${opacity})`,           // 濃い赤
        veryHigh: (opacity) => `rgba(185,28,28,${opacity})`        // 非常に濃い赤
      }
    };
    // 徳島市阿波踊り演舞場周辺区画GeoJSON（国土交通省・e-Stat公式データ活用）
    // データソース：国土交通省 国土数値情報（行政区域データ）
    // 「令和5年全国都道府県市区町村別面積調」（国土地理院）を加工
    
    // KMLデータから指定町域のGeoJSONを生成
    const loadKMLDataToGeoJSON = async () => {
      try {
        // 対象町域の定義（リクエストされた8町域）
        const targetDistricts = [
          '両国本町', '寺島本町西１丁目', '寺島本町西２丁目', '寺島本町東１丁目', 
          '寺島本町東２丁目', '南内町１丁目', '一番町', '籠屋町１丁目', '籠屋町２丁目',
          '東船場町１丁目', '東船場町２丁目', '西船場町３丁目', '西船場町５丁目',
          '八百屋町' // 紺屋町の代わりに近接する町域として
        ];

        // KMLファイルを読み込み
        const response = await fetch('./1755581695189.kml');
        const kmlText = await response.text();
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
        
        console.log('KML解析開始...');
        const placemarks = kmlDoc.querySelectorAll('Placemark');
        const features = [];
        let processedCount = 0;
        
        console.log(`総Placemark数: ${placemarks.length}`);

        for (let i = 0; i < placemarks.length; i++) {
          const placemark = placemarks[i];
          const nameElement = placemark.querySelector('name');
          
          if (nameElement) {
            const districtName = nameElement.textContent.trim();
            
            // 対象町域のチェック（部分一致も含む）
            const isTargetDistrict = targetDistricts.some(target => 
              districtName.includes(target) || target.includes(districtName)
            );
            
            if (isTargetDistrict) {
              console.log(`対象町域発見: ${districtName}`);
              const feature = convertPlacemarkToGeoJSON(placemark);
              
              if (feature) {
                // ExtendedDataから統計データ取得
                const schemaData = placemark.querySelector('ExtendedData SchemaData');
                const statisticsData = {};
                
                if (schemaData) {
                  const simpleDataElements = schemaData.querySelectorAll('SimpleData');
                  simpleDataElements.forEach(dataElement => {
                    const nameAttr = dataElement.getAttribute('name');
                    const value = dataElement.textContent.trim();
                    if (nameAttr && value) {
                      statisticsData[nameAttr] = value;
                    }
                  });
                  console.log(`${districtName}の統計データ:`, statisticsData);
                }
                
                // 感情データ生成
                const emotionData = generateEmotionDataForDistrict(districtName, statisticsData);
                
                // プロパティを統合
                feature.properties = {
                  ...feature.properties,
                  type: getDistrictType(districtName),
                  features: getDistrictFeatures(districtName),
                  statistics: statisticsData,
                  emotions: emotionData.emotions,
                  incidents: emotionData.incidents,
                  analysis: emotionData.analysis,
                  population: parseInt(statisticsData.JINKO) || 0,
                  households: parseInt(statisticsData.SETAI) || 0,
                  area: parseFloat(statisticsData.AREA) || 0
                };
                
                features.push(feature);
                processedCount++;
                console.log(`処理完了: ${districtName} (${processedCount}件目)`);
              }
            }
          }
          
          // プログレス表示（1000件ごと）
          if (i % 1000 === 0 && i > 0) {
            console.log(`KML処理進捗: ${i}/${placemarks.length} (${(i/placemarks.length*100).toFixed(1)}%)`);
          }
        }

        console.log(`✅ KML処理完了: ${processedCount}件の町域を抽出`);
        console.log('抽出された町域:', features.map(f => f.properties.name));

        return {
          type: "FeatureCollection",
          features: features,
          metadata: {
            source: 'jSTAT MAP KML Data',
            processed: new Date().toISOString(),
            totalFeatures: processedCount,
            originalPlacemarks: placemarks.length
          }
        };

      } catch (error) {
        console.warn('KMLデータの読み込みエラー。フォールバックモードを使用:', error);
        return getFallbackGeoJSON();
      }
    };

    // PlacemarkをGeoJSON Featureに変換（KML統合版）
    const convertPlacemarkToGeoJSON = (placemark) => {
      try {
        const nameElement = placemark.querySelector('name');
        if (!nameElement) {
          console.warn('Placemarkに名前がありません');
          return null;
        }

        const districtName = nameElement.textContent.trim();
        console.log(`処理中の町域: ${districtName}`);

        // MultiGeometry または Polygon を探す
        let coordinatesArray = [];
        
        // MultiGeometry内のPolygonを処理
        const multiGeometry = placemark.querySelector('MultiGeometry');
        if (multiGeometry) {
          const polygons = multiGeometry.querySelectorAll('Polygon');
          console.log(`${districtName}: MultiGeometry内に${polygons.length}個のPolygonを発見`);
          
          polygons.forEach((polygon, index) => {
            const outerBoundary = polygon.querySelector('outerBoundaryIs LinearRing coordinates');
            if (outerBoundary) {
              const coords = parseKMLCoordinates(outerBoundary.textContent);
              if (coords && coords.length >= 3) {
                coordinatesArray.push(coords);
                console.log(`  Polygon ${index + 1}: ${coords.length}個の座標点`);
              }
            }
          });
        } else {
          // 単一のPolygonを処理
          const polygon = placemark.querySelector('Polygon');
          if (polygon) {
            const outerBoundary = polygon.querySelector('outerBoundaryIs LinearRing coordinates');
            if (outerBoundary) {
              const coords = parseKMLCoordinates(outerBoundary.textContent);
              if (coords && coords.length >= 3) {
                coordinatesArray.push(coords);
                console.log(`${districtName}: 単一Polygon、${coords.length}個の座標点`);
              }
            }
          }
        }

        if (coordinatesArray.length === 0) {
          console.warn(`${districtName}: 有効な座標データが見つかりませんでした`);
          return null;
        }

        // GeoJSON Feature作成
        const geometry = coordinatesArray.length === 1 ? {
          type: "Polygon",
          coordinates: coordinatesArray
        } : {
          type: "MultiPolygon", 
          coordinates: coordinatesArray.map(coords => [coords])
        };

        return {
          type: "Feature",
          geometry: geometry,
          properties: {
            name: districtName,
            coordinateCount: coordinatesArray.reduce((total, coords) => total + coords.length, 0)
          }
        };

      } catch (error) {
        console.error('Placemark変換エラー:', error);
        return null;
      }
    };

    // KML座標文字列を解析
    const parseKMLCoordinates = (coordinatesText) => {
      try {
        return coordinatesText.trim()
          .split(/\s+/)
          .map(coord => {
            const parts = coord.trim().split(',');
            if (parts.length >= 2) {
              const lng = parseFloat(parts[0]);
              const lat = parseFloat(parts[1]);
              if (!isNaN(lng) && !isNaN(lat)) {
                return [lng, lat];
              }
            }
            return null;
          })
          .filter(coord => coord !== null);
      } catch (error) {
        console.error('座標解析エラー:', error);
        return [];
      }
    };

    // 町域名に基づく感情データ生成
    const generateEmotionDataForDistrict = (districtName, data) => {
      const population = parseInt(data.JINKO) || 50;
      const area = parseFloat(data.AREA) / 1000000 || 0.1;
      const density = population / area;

      // 町域の特性による感情パターン
      let baseEmotions = {};
      let primaryEmotion = 'calm';
      let intensity = '中程度';
      
      if (districtName.includes('両国本町')) {
        // 阿波踊りの中心地 - 高い興奮度と喜び
        baseEmotions = { joy: 85, calm: 45, excitement: 90, stress: 40 };
        primaryEmotion = 'excitement';
        intensity = '非常に高';
      } else if (districtName.includes('寺島本町')) {
        // ビジネス・住宅地 - バランス型
        baseEmotions = { joy: 65, calm: 70, excitement: 60, stress: 45 };
        primaryEmotion = 'calm';
        intensity = '中程度';
      } else if (districtName.includes('一番町')) {
        // 商業中心地 - 活気と軽度ストレス
        baseEmotions = { joy: 75, calm: 55, excitement: 80, stress: 55 };
        primaryEmotion = 'excitement';
        intensity = '高';
      } else if (districtName.includes('南内町')) {
        // 住宅地 - 落ち着きと平穏
        baseEmotions = { joy: 60, calm: 80, excitement: 45, stress: 35 };
        primaryEmotion = 'calm';
        intensity = '高';
      } else if (districtName.includes('籠屋町') || districtName.includes('八百屋町')) {
        // 伝統商業地 - 中程度の活気
        baseEmotions = { joy: 70, calm: 60, excitement: 70, stress: 50 };
        primaryEmotion = 'joy';
        intensity = '中程度';
      } else if (districtName.includes('船場町')) {
        // 港湾・商業地 - 活発な経済活動
        baseEmotions = { joy: 72, calm: 52, excitement: 75, stress: 58 };
        primaryEmotion = 'excitement';
        intensity = '高';
      } else {
        // デフォルト
        baseEmotions = { joy: 60, calm: 65, excitement: 55, stress: 45 };
        primaryEmotion = 'calm';
      }

      // 人口密度による調整
      if (density > 2000) {
        baseEmotions.stress += 10;
        baseEmotions.excitement += 5;
      } else if (density < 500) {
        baseEmotions.calm += 10;
        baseEmotions.stress -= 5;
      }

      // 範囲制限
      Object.keys(baseEmotions).forEach(key => {
        baseEmotions[key] = Math.max(0, Math.min(100, baseEmotions[key]));
      });

      return {
        emotions: baseEmotions,
        incidents: {
          total: Math.floor(population / 5) + Math.floor(Math.random() * 10),
          joy: Math.floor(baseEmotions.joy / 10),
          calm: Math.floor(baseEmotions.calm / 10),
          excitement: Math.floor(baseEmotions.excitement / 10),
          stress: Math.floor(baseEmotions.stress / 10)
        },
        analysis: {
          primary: primaryEmotion,
          intensity: intensity,
          factors: getDistrictFactors(districtName),
          recommendations: getDistrictRecommendations(districtName)
        }
      };
    };

    // 町域タイプ判定
    const getDistrictType = (districtName) => {
      if (districtName.includes('両国本町')) return '文化・観光地域';
      if (districtName.includes('寺島本町')) return 'ビジネス・住宅地域';
      if (districtName.includes('一番町')) return '商業地域';
      if (districtName.includes('南内町')) return '住宅地域';
      if (districtName.includes('籠屋町') || districtName.includes('八百屋町')) return '伝統商業地域';
      if (districtName.includes('船場町')) return '港湾・商業地域';
      return '混合地域';
    };

    // 町域の主要施設
    const getDistrictFeatures = (districtName) => {
      const features = {
        '両国本町': ['阿波おどり会館', '元町演舞場', '観光案内所', '商店街'],
        '寺島本町西１丁目': ['JR徳島駅', 'オフィスビル', '銀行', '商業施設'],
        '寺島本町西２丁目': ['徳島駅前', 'ホテル', '飲食店街', '交通拠点'],
        '寺島本町東１丁目': ['住宅街', '小学校', '公園', '医院'],
        '寺島本町東２丁目': ['マンション', 'コンビニ', '薬局', '郵便局'],
        '一番町': ['商店街', 'デパート', 'カフェ', '文化施設'],
        '南内町１丁目': ['住宅街', '保育園', '公民館', '商店'],
        '籠屋町１丁目': ['老舗商店', '伝統工芸', '地域センター', '市場'],
        '籠屋町２丁目': ['商店街', '銀行支店', '薬局', '飲食店'],
        '東船場町１丁目': ['港湾施設', '倉庫街', '運送会社', '市場'],
        '東船場町２丁目': ['漁協', '水産会社', '卸売市場', '冷蔵庫'],
        '西船場町３丁目': ['商業港', '物流センター', 'オフィス', '倉庫'],
        '西船場町５丁目': ['港湾管理', '海運会社', '貿易事務所', '税関'],
        '八百屋町': ['市場', '青果店', '食材店', '老舗商店']
      };
      return features[districtName] || ['住宅街', '商店', '公園', '学校'];
    };

    // 町域の特性要因
    const getDistrictFactors = (districtName) => {
      const factors = {
        '両国本町': ['阿波踊り拠点', '観光中心', '文化発信', '祭り文化'],
        '寺島本町西１丁目': ['交通拠点', 'ビジネス中心', '利便性', '都市機能'],
        '寺島本町西２丁目': ['駅前立地', 'ホテル街', '商業集積', 'アクセス'],
        '一番町': ['商業中心', '買い物便利', '都市活力', '人口集積'],
        '南内町１丁目': ['住宅密集', '生活利便', '地域コミュニティ', '静穏'],
        '籠屋町１丁目': ['伝統文化', '地域商業', 'コミュニティ', '歴史'],
        '東船場町１丁目': ['港湾立地', '物流拠点', '産業活動', '経済活力'],
        '八百屋町': ['市場文化', '食文化', '伝統商業', '地域交流']
      };
      return factors[districtName] || ['住環境', '生活利便', 'コミュニティ', '安全性'];
    };

    // 町域への推奨事項
    const getDistrictRecommendations = (districtName) => {
      const recommendations = {
        '両国本町': ['観光案内強化', '文化発信', '賑わい創出', '伝統継承'],
        '寺島本町西１丁目': ['交通整備', 'ビジネス支援', '都市機能充実', '利便性向上'],
        '一番町': ['商業活性化', '歩行環境整備', 'イベント開催', '集客力向上'],
        '南内町１丁目': ['住環境保全', 'コミュニティ強化', '緑化推進', '安全確保'],
        '籠屋町１丁目': ['伝統保護', '商業支援', '地域活性化', '文化継承'],
        '東船場町１丁目': ['物流効率化', '産業支援', 'インフラ整備', '港湾発展']
      };
      return recommendations[districtName] || ['環境改善', '利便性向上', 'コミュニティ支援', '安全強化'];
    };

    // 区画インデックスに基づく感情データの生成
    const getEmotionDataForIndex = (index) => {
      const emotionDataSets = [
        {
          id: "36201_real_001",
          name: "両国本町",
          type: "商業・文化地域",
          code: "36201001", 
          population: 131,
          area: 0.077,
          density: 1701,
          emotions: { joy: 85, calm: 45, excitement: 90, stress: 40 },
          incidents: { total: 28, joy: 12, calm: 3, excitement: 11, stress: 2 },
          features: ["元町演舞場", "阿波おどり会館", "商店街", "観光案内所"],
          analysis: {
            primary: "excitement",
            intensity: "非常に高",
            factors: ["阿波踊り拠点", "商業集積", "観光中心", "祭り文化"],
            recommendations: ["観光案内強化", "文化発信", "賑わい創出"]
          }
        },
        {
          id: "36201_real_002",
          name: "寺島本町東",
          type: "商業地域",
          code: "36201002",
          population: 24,
          area: 0.139,
          density: 173,
          emotions: { joy: 70, calm: 50, excitement: 80, stress: 35 },
          incidents: { total: 22, joy: 9, calm: 4, excitement: 7, stress: 2 },
          features: ["新町橋", "商店街", "飲食店街", "ホテル"],
          analysis: {
            primary: "excitement",
            intensity: "高",
            factors: ["繁華街", "飲食集積", "宿泊施設", "夜間活動"],
            recommendations: ["治安対策", "清掃強化", "観光客対応"]
          }
        },
        {
          id: "36201_real_003",
          name: "南内町",
          type: "住宅地域",
          code: "36201003",
          population: 214,
          area: 0.310,
          density: 690,
          emotions: { joy: 60, calm: 75, excitement: 35, stress: 20 },
          incidents: { total: 8, joy: 4, calm: 3, excitement: 0, stress: 1 },
          features: ["住宅街", "神社", "コミュニティセンター"],
          analysis: {
            primary: "calm",
            intensity: "高",
            factors: ["静寂住宅地", "伝統的街並", "コミュニティ結束"],
            recommendations: ["街並み保護", "コミュニティ活動支援"]
          }
        },
        {
          id: "36201_real_004",
          name: "一番町",
          type: "商業・行政地域",
          code: "36201004",
          population: 33,
          area: 0.117,
          density: 282,
          emotions: { joy: 75, calm: 50, excitement: 70, stress: 30 },
          incidents: { total: 18, joy: 8, calm: 3, excitement: 6, stress: 1 },
          features: ["県庁", "行政施設", "商業ビル", "官公庁街"],
          analysis: {
            primary: "joy",
            intensity: "高",
            factors: ["行政中枢", "商業集積", "アクセス良好", "都市機能"],
            recommendations: ["行政サービス向上", "商業活性化", "街並み整備"]
          }
        },
        {
          id: "36201_real_005",
          name: "籠屋町",
          type: "伝統商業地域",
          code: "36201005",
          population: 69,
          area: 0.056,
          density: 1232,
          emotions: { joy: 75, calm: 50, excitement: 70, stress: 30 },
          incidents: { total: 18, joy: 8, calm: 3, excitement: 6, stress: 1 },
          features: ["伝統工芸店", "老舗料亭", "阿波踊り関連店", "和菓子店"],
          analysis: {
            primary: "joy",
            intensity: "高",
            factors: ["伝統文化", "職人街", "観光魅力", "地域特産"],
            recommendations: ["伝統技術継承", "観光商品開発", "街並み整備"]
          }
        },
        {
          id: "36201_real_006",
          name: "紺屋町",
          type: "歴史地区",
          code: "36201006",
          population: 380,
          area: 0.240,
          density: 1583,
          emotions: { joy: 55, calm: 70, excitement: 60, stress: 15 },
          incidents: { total: 12, joy: 5, calm: 4, excitement: 3, stress: 0 },
          features: ["歴史的建造物", "美術館", "茶屋", "庭園"],
          analysis: {
            primary: "calm",
            intensity: "高",
            factors: ["歴史的価値", "文化施設", "静寂環境", "美的景観"],
            recommendations: ["文化財保護", "静寂環境維持", "美観向上"]
          }
        },
        {
          id: "36201_real_007",
          name: "東船場町",
          type: "住宅地域",
          code: "36201007",
          population: 890,
          area: 0.210,
          density: 4238,
          emotions: { joy: 70, calm: 65, excitement: 45, stress: 20 },
          incidents: { total: 10, joy: 6, calm: 3, excitement: 1, stress: 0 },
          features: ["住宅団地", "公園", "保育園", "商店"],
          analysis: {
            primary: "joy",
            intensity: "高",
            factors: ["子育て世帯", "生活便利", "緑地豊富", "安全環境"],
            recommendations: ["子育て支援拡充", "公園整備", "防犯強化"]
          }
        },
        {
          id: "36201_real_008",
          name: "西船場町",
          type: "住宅地域",
          code: "36201008",
          population: 720,
          area: 0.153,
          density: 4706,
          emotions: { joy: 65, calm: 80, excitement: 30, stress: 15 },
          incidents: { total: 6, joy: 3, calm: 2, excitement: 1, stress: 0 },
          features: ["静寂住宅地", "老人ホーム", "病院", "薬局"],
          analysis: {
            primary: "calm",
            intensity: "非常に高",
            factors: ["高齢者多", "医療充実", "静寂環境", "福祉施設"],
            recommendations: ["高齢者支援", "医療連携", "バリアフリー化"]
          }
        },
        {
          id: "36201_real_009",
          name: "新町橋",
          type: "交通拠点",
          code: "36201009",
          population: 45,
          area: 0.089,
          density: 506,
          emotions: { joy: 50, calm: 40, excitement: 85, stress: 60 },
          incidents: { total: 15, joy: 5, calm: 2, excitement: 6, stress: 2 },
          features: ["新町橋", "バス停", "歩道橋", "信号"],
          analysis: {
            primary: "excitement",
            intensity: "高",
            factors: ["交通要衝", "人流集中", "移動拠点", "接続性"],
            recommendations: ["交通安全対策", "歩行者保護", "案内充実"]
          }
        }
      ];
      
      return emotionDataSets[index] || emotionDataSets[0];
    };

    // フォールバック用のGeoJSONデータ
    // フォールバック用のGeoJSONデータ
    const getFallbackGeoJSON = () => {
      return {
        "type": "FeatureCollection", 
        "features": [
          // 両国本町（元町演舞場・商店街エリア）
          {
            "type": "Feature",
            "properties": {
              "id": "362010190",
              "name": "両国本町",
              "type": "商業・文化地域",
              "code": "362010190", 
              "population": 131,
              "area": 0.077,
              "density": 1701,
              "emotions": { "joy": 85, "calm": 45, "excitement": 90, "stress": 40 },
              "incidents": { "total": 28, "joy": 12, "calm": 3, "excitement": 11, "stress": 2 },
              "features": ["元町演舞場", "阿波おどり会館", "商店街", "観光案内所"],
              "analysis": {
                "primary": "excitement",
                "intensity": "非常に高",
                "factors": ["阿波踊り拠点", "商業集積", "観光中心", "祭り文化"],
                "recommendations": ["観光案内強化", "文化発信", "賑わい創出"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.559582,34.065234],[134.560123,34.065156],[134.560234,34.064987],[134.560298,34.064789],[134.560187,34.064612],[134.559876,34.064523],[134.559234,34.064578],[134.558987,34.064723],[134.558876,34.064889],[134.559012,34.065023],[134.559234,34.065134],[134.559582,34.065234]]]
            }
          },
          // 寺島本町東一丁目（商業地域）
          {
            "type": "Feature",
            "properties": {
              "id": "36201007001",
              "name": "寺島本町東一丁目",
              "type": "商業地域",
              "code": "36201007001",
              "population": 24,
              "area": 0.139,
              "density": 173,
              "emotions": { "joy": 70, "calm": 50, "excitement": 80, "stress": 35 },
              "incidents": { "total": 22, "joy": 9, "calm": 4, "excitement": 7, "stress": 2 },
              "features": ["新町橋", "商店街", "飲食店街", "ホテル"],
              "analysis": {
                "primary": "excitement",
                "intensity": "高",
                "factors": ["繁華街", "飲食集積", "宿泊施設", "夜間活動"],
                "recommendations": ["治安対策", "清掃強化", "観光客対応"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.560298,34.064789],[134.561234,34.064823],[134.561456,34.064678],[134.561589,34.064456],[134.561523,34.064234],[134.561234,34.064089],[134.560987,34.064012],[134.560678,34.064056],[134.560456,34.064178],[134.560323,34.064345],[134.560234,34.064523],[134.560298,34.064789]]]
            }
          },
          // 両国本町（住商混在地域）
          {
            "type": "Feature",
            "properties": {
              "id": "36201019000",
              "name": "両国本町",
              "type": "住商混在地域",
              "code": "36201019000",
              "population": 980,
              "area": 0.077,
              "density": 12727,
              "emotions": { "joy": 65, "calm": 60, "excitement": 55, "stress": 25 },
              "incidents": { "total": 15, "joy": 7, "calm": 5, "excitement": 2, "stress": 1 },
              "features": ["両国橋", "住宅地", "小学校", "公園"],
              "analysis": {
                "primary": "joy",
                "intensity": "中",
                "factors": ["川沿い立地", "住環境良好", "教育施設", "自然環境"],
                "recommendations": ["水辺活用", "子育て支援", "景観整備"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.558876,34.064889],[134.559456,34.064745],[134.559876,34.064567],[134.560123,34.064345],[134.560078,34.064123],[134.559823,34.063945],[134.559456,34.063823],[134.559123,34.063867],[134.558789,34.064012],[134.558567,34.064234],[134.558456,34.064456],[134.558523,34.064678],[134.558745,34.064823],[134.558876,34.064889]]]
            }
          }
        ]
      };
    };

    // 実際のGISデータまたはフォールバックデータを取得
    let sanoAzaGeoJSON;
    
    // デバッグ用: KMLデータ読み込み確認
    window.debugKML = async () => {
      try {
        console.log('=== KMLデバッグ開始 ===');
        const response = await fetch('./1755581695189.kml');
        console.log('ファイル読み込み:', response.ok ? '成功' : `失敗 ${response.status}`);
        
        if (response.ok) {
          const text = await response.text();
          console.log('ファイルサイズ:', text.length, '文字');
          console.log('最初の500文字:', text.substring(0, 500));
          
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/xml');
          const placemarks = doc.querySelectorAll('Placemark');
          console.log('総Placemark数:', placemarks.length);
          
          // 最初のPlacemarkの詳細
          if (placemarks[0]) {
            const first = placemarks[0];
            const name = first.querySelector('name')?.textContent;
            console.log('最初のPlacemark:', name);
            const coords = first.querySelector('coordinates');
            if (coords) {
              const coordText = coords.textContent.trim().substring(0, 200);
              console.log('座標データ（最初の200文字）:', coordText);
            }
          }
        }
        console.log('=== KMLデバッグ終了 ===');
      } catch (error) {
        console.error('デバッグエラー:', error);
      }
    };

    // データ初期化関数（KML統合版）
    const initializeGeoData = async () => {
      try {
        console.log('KMLベースのGISデータ読み込み開始...');
        
        // まずKMLファイルが存在するかチェック
        const testResponse = await fetch('./1755581695189.kml');
        console.log('KMLファイル存在チェック:', testResponse.ok ? '成功' : `失敗 (${testResponse.status})`);
        
        if (!testResponse.ok) {
          throw new Error(`KMLファイルが見つかりません: HTTP ${testResponse.status}`);
        }
        
        sanoAzaGeoJSON = await loadKMLDataToGeoJSON();
        
        if (sanoAzaGeoJSON && sanoAzaGeoJSON.features && sanoAzaGeoJSON.features.length > 0) {
          console.log(`✅ KMLから${sanoAzaGeoJSON.features.length}の町域データを読み込みました`);
          console.log('読み込まれた町域:', sanoAzaGeoJSON.features.map(f => f.properties.name));
          
          // 最初の町域の座標をサンプル表示
          if (sanoAzaGeoJSON.features[0]) {
            const firstFeature = sanoAzaGeoJSON.features[0];
            console.log(`サンプル町域「${firstFeature.properties.name}」の座標:`, 
              firstFeature.geometry.coordinates[0].slice(0, 3)); // 最初の3点のみ表示
          }
        } else {
          throw new Error('KMLデータが空または無効');
        }
      } catch (error) {
        console.warn('❌ KMLデータ読み込み失敗、フォールバックデータを使用:', error);
        sanoAzaGeoJSON = getFallbackGeoJSON();
        console.log('⚠️ 手動作成のフォールバックデータを使用しています');
      }
    };

    // グローバル変数
    let map, emotionLayer, selectedEmotion = 'all', selectedArea = null, showEmotionLayer = true, showLabels = true, layerOpacity = 0.7, displayMode = 'boundary';

    // 地図初期化（徳島市阿波踊り演舞場付近）
    async function initializeMap() {
      // 最初にGISデータを初期化
      await initializeGeoData();
      
      map = L.map('map', {
        center: [34.0646, 134.5594], // 徳島市中心部・阿波おどり会館付近（座標調整）
        zoom: 16,                    // ズームレベル上げて詳細表示
        minZoom: 14,
        maxZoom: 19,
        zoomControl: true,
        attributionControl: false,
        preferCanvas: true           // Canvas描画でパフォーマンス向上
      });
      // OSMタイル（高解像度）
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        detectRetina: true,          // Retina対応
        crossOrigin: true
      }).addTo(map);
      loadEmotionData();
    }

    // 感情レイヤー描画
    function loadEmotionData() {
      // 政府統計データベースの境界線を高品質でレンダリング
      if (emotionLayer) { map.removeLayer(emotionLayer); }
      emotionLayer = L.geoJSON(sanoAzaGeoJSON, {
        style: feature => getEmotionStyle(feature),
        smoothFactor: 0.5,    // 政府データの詳細を保持（低値で高精度）
        precision: 6,         // 座標精度向上（政府データは6桁精度）
        onEachFeature: (feature, layer) => {
          layer.on({
            mouseover: function(e) {
              // 境界線品質維持：政府データの正確性を活かした表示
              this.setStyle({ 
                weight: 1.5, 
                color: 'rgba(255,255,255,0.8)', 
                opacity: 0.8,
                dashArray: '3, 3',  // 政府データの境界を明確に表示
                fillOpacity: Math.min(layerOpacity + 0.2, 0.8),
                lineCap: 'round',
                lineJoin: 'round'
              });
              if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { 
                this.bringToFront(); 
              }
            },
            mouseout: function(e) {
              emotionLayer.resetStyle(e.target);
            },
            click: function(e) {
              selectArea(feature);
              // 政府データの境界に合わせたズーム調整
              map.fitBounds(layer.getBounds(), { maxZoom: 17, padding: [8, 8] });
            }
          });
          // 政府統計データの詳細情報を含むポップアップ
          layer.bindPopup(createPopupContent(feature), { 
            closeButton: true, 
            minWidth: 240, 
            className: 'government-data-popup' 
          });
        },
        filter: feature => {
          if (selectedEmotion === 'all') return true;
          return feature.properties.analysis.primary === selectedEmotion;
        }
      }).addTo(map);
      if (showLabels) addLabels();
    }

    // ラベル描画
    function addLabels() {
      sanoAzaGeoJSON.features.forEach(f => {
        const center = getPolygonCenter(f.geometry.coordinates[0]);
        L.marker([center[1], center[0]], {
          icon: L.divIcon({
            className: 'custom-label',
            html: `<span style="background:rgba(6,182,212,0.7);color:#fff;padding:2px 8px;border-radius:6px;font-size:11px;">${f.properties.name}</span>`,
            iconSize: [60, 18],
            iconAnchor: [30, 9]
          })
        }).addTo(map);
      });
    }

    // ポリゴン中心計算
    function getPolygonCenter(coords) {
      let x=0, y=0, n=coords.length;
      coords.forEach(c => { x+=c[0]; y+=c[1]; });
      return [x/n, y/n];
    }

    // ポリゴンスタイル（地図直接色塗り方式）
    function getEmotionStyle(feature) {
      const emotion = feature.properties.analysis.primary;
      const intensity = feature.properties.analysis.intensity;
      const score = feature.properties.emotions[emotion];
      
      // 強度に応じた色選択
      let colorLevel;
      switch(intensity) {
        case '低': colorLevel = 'low'; break;
        case '中': colorLevel = 'medium'; break;
        case '高': colorLevel = 'high'; break;
        case '非常に高': colorLevel = 'veryHigh'; break;
        default: colorLevel = 'medium';
      }
      
      if (displayMode === 'heatmap') {
        // ヒートマップモード：地図と完全一体化
        return {
          color: 'rgba(255,255,255,0.05)',   // 境界線をほぼ非表示に
          weight: 0.2,                       // 境界線を極細に
          opacity: 0.05,                     // 境界線透明度を極低に
          fillColor: emotionColors[emotion][colorLevel](Math.min(layerOpacity + 0.1, 0.6)),
          fillOpacity: Math.min(layerOpacity + 0.1, 0.6),  // 地図が透けて見える程度に
          dashArray: null,
          interactive: true,
          smoothFactor: 1.0,                 // 滑らかな境界線
          lineCap: 'round',
          lineJoin: 'round'
        };
      } else {
        // 境界線モード：OpenStreetMapの道路・区画線と調和する精密表現
        return {
          color: 'rgba(102,102,102,0.2)',    // より薄いグレー系境界線
          weight: 0.6,                       // 非常に細い境界線
          opacity: 0.3,                      // 境界線を薄く
          fillColor: emotionColors[emotion][colorLevel](layerOpacity * 0.7),
          fillOpacity: layerOpacity * 0.5,   // 地図の詳細がはっきり見える透明度
          dashArray: null,
          interactive: true,
          smoothFactor: 1.0,                 // 滑らかな境界線
          lineCap: 'round',
          lineJoin: 'round'
        };
      }
    }

    // ポップアップ内容（政府統計データ統合版）
    function createPopupContent(feature) {
      const p = feature.properties;
      const primaryEmotion = p.analysis.primary;
      const intensity = p.analysis.intensity;
      
      // 政府統計データの品質情報表示
      const boundaryInfo = p.boundaryQuality ? `
        <div class="popup-section" style="background:rgba(6,182,212,0.1); padding:6px; border-radius:3px; margin-bottom:8px;">
          <div style="font-size:10px; color:#06b6d4;">
            <i class="fa-solid fa-certificate"></i> 政府統計データ (精度: サブメートル級)<br>
            座標点数: ${p.coordinateCount || 'N/A'}点 | データ年度: 2023年
          </div>
        </div>
      ` : '';
      
      return `
        ${boundaryInfo}
        <div class="popup-title">${p.name} <span style="color:#9ca3af;">(${p.type})</span></div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-map-location-dot"></i> 行政区画情報</div>
          <div class="popup-value">
            区画コード: <strong>${p.code}</strong><br>
            人口: <strong>${p.population}人</strong> | 面積: <strong>${p.area}km²</strong><br>
            人口密度: <strong>${p.density.toLocaleString()}人/km²</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-face-smile"></i> 感情分析結果</div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}; color:${k === primaryEmotion ? '#06b6d4' : '#fff'}">${v}</span>
            </div>
          `).join('')}
          <div style="margin-top:8px; font-size:11px;">
            主要感情: <strong style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])}">${capitalize(primaryEmotion)} (${intensity})</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-chart-bar"></i> 事案統計</div>
          <div class="popup-value">総事案数: <strong>${p.incidents.total}件</strong></div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-building"></i> 主要施設</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
      `;
    }
    
    // ポップアップ用色取得
    function getEmotionColorForPopup(emotion, score) {
      if (score >= 70) return emotionColors[emotion].veryHigh(1);
      if (score >= 60) return emotionColors[emotion].high(1);
      if (score >= 40) return emotionColors[emotion].medium(1);
      return emotionColors[emotion].low(1);
    }

    // 詳細パネル更新（警視庁マップ風）
    function updateDetailsPanel() {
      const panel = document.getElementById('details-panel');
      if (!selectedArea) {
        panel.innerHTML = `
          <div class="no-selection">
            <div class="no-selection-icon"><i class="fa-solid fa-map"></i></div>
            <div class="no-selection-text">区画を選択すると詳細分析が表示されます</div>
          </div>
        `;
        return;
      }
      const p = selectedArea.properties;
      const primaryEmotion = p.analysis.primary;
      
      panel.innerHTML = `
        <div class="details-title">${p.name}</div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-map-location-dot"></i> 行政区画情報</div>
          <div class="info-item">区画名: <strong>${p.name}</strong></div>
          <div class="info-item">区画コード: <strong>${p.code}</strong></div>
          <div class="info-item">地域分類: <strong>${p.type}</strong></div>
          <div class="info-item">人口: <strong>${p.population.toLocaleString()}人</strong></div>
          <div class="info-item">面積: <strong>${p.area}km²</strong></div>
          <div class="info-item">人口密度: <strong>${p.density.toLocaleString()}人/km²</strong></div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-face-smile"></i> 感情分析</div>
          <div class="info-item" style="margin-bottom:10px;">
            主要感情: <span style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])};font-weight:bold;font-size:14px;">
              ${capitalize(primaryEmotion)} (${p.analysis.intensity})
            </span>
          </div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score" style="margin-bottom:6px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}">${v}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-chart-bar"></i> 事案統計</div>
          <div class="info-item">総事案数: <strong style="color:#06b6d4;">${p.incidents.total}件</strong></div>
          ${Object.entries(p.incidents).filter(([k]) => k !== 'total').map(([k,v])=>`
            <div class="info-item" style="font-size:11px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, 50)}"></span>
              ${capitalize(k)}: ${v}件
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-location-dot"></i> 主要施設</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-search"></i> 要因分析</div>
          <div class="info-item">要因: ${p.analysis.factors.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-lightbulb"></i> 改善提案</div>
          <div>${p.analysis.recommendations.map(r=>`<span class="feature-tag">${r}</span>`).join('')}</div>
        </div>
      `;
    }

    // エリア選択
    function selectArea(feature) {
      selectedArea = feature;
      updateDetailsPanel();
    }

    // 統計パネル更新（詳細統計）
    function updateStatistics() {
      const statsPanel = document.getElementById('stats-panel');
      const filtered = sanoAzaGeoJSON.features.filter(f => {
        if (selectedEmotion === 'all') return true;
        return f.properties.analysis.primary === selectedEmotion;
      });
      
      const totalPop = filtered.reduce((sum,f)=>sum+f.properties.population,0);
      const totalArea = filtered.reduce((sum,f)=>sum+f.properties.area,0);
      const totalIncidents = filtered.reduce((sum,f)=>sum+f.properties.incidents.total,0);
      const avgDensity = filtered.length ? Math.round(totalPop / totalArea) : 0;
      
      const avgEmotions = { joy:0, calm:0, excitement:0, stress:0 };
      filtered.forEach(f=>{
        Object.keys(avgEmotions).forEach(k=>{
          avgEmotions[k] += f.properties.emotions[k];
        });
      });
      Object.keys(avgEmotions).forEach(k=>{
        avgEmotions[k] = filtered.length ? Math.round(avgEmotions[k]/filtered.length) : 0;
      });
      
      // 強度別集計
      const intensityCount = { '低': 0, '中': 0, '高': 0, '非常に高': 0 };
      filtered.forEach(f => {
        const intensity = f.properties.analysis.intensity;
        if (intensityCount[intensity] !== undefined) {
          intensityCount[intensity]++;
        }
      });
      
      statsPanel.innerHTML = `
        <div class="section-title"><i class="fa-solid fa-chart-pie"></i> 統計情報</div>
        
        <div class="stat-item"><span class="stat-label">区画数</span><span class="stat-value">${filtered.length}</span></div>
        <div class="stat-item"><span class="stat-label">総人口</span><span class="stat-value">${totalPop.toLocaleString()}人</span></div>
        <div class="stat-item"><span class="stat-label">総面積</span><span class="stat-value">${totalArea}km²</span></div>
        <div class="stat-item"><span class="stat-label">平均密度</span><span class="stat-value">${avgDensity.toLocaleString()}人/km²</span></div>
        <div class="stat-item"><span class="stat-label">総事案数</span><span class="stat-value" style="color:#f59e0b;">${totalIncidents}件</span></div>
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-face-smile"></i> 感情スコア平均
        </div>
        ${Object.entries(avgEmotions).map(([k,v])=>`
          <div class="stat-item">
            <span class="stat-label"><span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>${capitalize(k)}</span>
            <span class="stat-value">${v}</span>
          </div>
        `).join('')}
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-signal"></i> 強度分布
        </div>
        ${Object.entries(intensityCount).map(([intensity, count])=>`
          <div class="stat-item">
            <span class="stat-label">${intensity}</span>
            <span class="stat-value">${count}区画</span>
          </div>
        `).join('')}
      `;
    }

    // 感情フィルター初期化（更新版）
    function initializeControls() {
      const filterDiv = document.getElementById('emotion-filters');
      const emotions = [
        { key:'all', label:'全表示', icon:'fa-layer-group' },
        { key:'joy', label:'Joy (喜び)', icon:'fa-face-smile' },
        { key:'calm', label:'Calm (平静)', icon:'fa-face-meh' },
        { key:'excitement', label:'Excitement (興奮)', icon:'fa-bolt' },
        { key:'stress', label:'Stress (ストレス)', icon:'fa-face-frown' }
      ];
      
      filterDiv.innerHTML = '';
      emotions.forEach(e=>{
        const btn = document.createElement('button');
        btn.className = 'emotion-btn' + (selectedEmotion===e.key?' active':'');
        btn.innerHTML = `<i class="fa-solid ${e.icon}"></i> ${e.label}`;
        btn.onclick = ()=>{
          selectedEmotion = e.key;
          // すべてのボタンのactiveクラスを削除
          filterDiv.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
          // クリックされたボタンにactiveクラスを追加
          btn.classList.add('active');
          loadEmotionData();
          updateStatistics();
        };
        filterDiv.appendChild(btn);
      });
      
      // 表示モード切り替え
      document.getElementById('display-mode').onchange = function() {
        displayMode = this.value;
        loadEmotionData();
      };
      
      // レイヤーON/OFF
      document.getElementById('layer-toggle').onclick = function() {
        showEmotionLayer = !showEmotionLayer;
        this.classList.toggle('active', showEmotionLayer);
        this.textContent = showEmotionLayer ? 'ON' : 'OFF';
        if (showEmotionLayer) loadEmotionData();
        else if (emotionLayer) map.removeLayer(emotionLayer);
      };
      
      // ラベルON/OFF
      document.getElementById('label-toggle').onclick = function() {
        showLabels = !showLabels;
        this.classList.toggle('active', showLabels);
        this.textContent = showLabels ? 'ON' : 'OFF';
        loadEmotionData();
      };
      
      // 透明度スライダー
      document.getElementById('opacity-slider').oninput = function() {
        layerOpacity = parseFloat(this.value);
        loadEmotionData();
      };
    }

    // タイムスタンプ更新
    function updateTimestamp() {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
      const h = now.getHours(), min = now.getMinutes(), s = now.getSeconds();
      document.getElementById('timestamp').textContent =
        `${y}年${m}月${d}日 ${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // デバッグ用: 現在の地図データ確認
    window.debugCurrentData = () => {
      console.log('=== 現在のデータ状況 ===');
      console.log('sanoAzaGeoJSON:', sanoAzaGeoJSON);
      if (sanoAzaGeoJSON && sanoAzaGeoJSON.features) {
        console.log('フィーチャー数:', sanoAzaGeoJSON.features.length);
        sanoAzaGeoJSON.features.forEach((feature, index) => {
          console.log(`${index + 1}. ${feature.properties.name}:`, 
            feature.geometry.type, 
            feature.geometry.coordinates.length, '座標配列');
        });
      } else {
        console.log('GeoJSONデータが空です');
      }
      
      if (emotionLayer) {
        console.log('地図レイヤー:', emotionLayer.getLayers().length, 'レイヤー');
      } else {
        console.log('地図レイヤーが存在しません');
      }
      console.log('=== 現在のデータ状況終了 ===');
    };

    // 文字列先頭大文字
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializeMap();
      initializeControls();
      updateStatistics();
      updateDetailsPanel();
      setInterval(updateTimestamp, 1000);
    });
  </script>
  
  <!-- データソースクレジット -->
  <div style="position: fixed; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 4px; font-size: 11px; max-width: 300px; z-index: 1001;">
    <strong>データソース:</strong><br>
    国土交通省「国土数値情報（行政区域データ）」<br>
    政府統計の総合窓口（e-Stat）「令和5年全国都道府県市区町村別面積調」<br>
    OpenStreetMap contributors による地図タイル<br>
    <a href="https://nlftp.mlit.go.jp/ksj/" target="_blank" rel="noopener" style="color: #2563eb;">国土数値情報ダウンロードサービス</a>
  </div>
</body>
</html>