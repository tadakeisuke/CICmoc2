<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMOTERRAIN - Tokushima City Emotion Map (Awa Odori Area)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a22;
      --text: #e6e6e6;
      --muted: #9aa3b2;
      --accent: #4ea0ff;
      --border: #232634;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .app { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: auto 1fr; height: 100%; }
    header { grid-column: 1 / -1; padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); }
    header h1 { font-size: 18px; font-weight: 600; margin: 0; }
    header .status { margin-left: auto; font-size: 12px; color: var(--muted); }

    .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 12px; display: flex; flex-direction: column; gap: 12px; }
    .card { background: #12151c; border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .card h2 { margin: 0 0 8px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing: .3px; }

    .filters { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .filters button { background: #0f1320; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; font-size: 13px; cursor: pointer; transition: .15s ease; }
    .filters button:hover { border-color: #2b3042; }
    .filters button.active { background: #12223a; border-color: var(--accent); color: #d7e9ff; box-shadow: inset 0 0 0 1px rgba(78,160,255,.35); }

    .range { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .range input[type="range"] { width: 100%; }
    .range .value { font-size: 12px; color: var(--muted); }

    #map { width: 100%; height: calc(100vh - 54px); }

    .notice { font-size: 12px; color: var(--muted); }
    .error { color: #ff6b6b; }
    .loading { color: var(--muted); }

  .legend { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
    .legend .item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
    .legend .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid var(--border); }
  .legend .swatch.joy { background: #ffd94a; }
  .legend .swatch.calm { background: #4ea0ff; }
  .legend .swatch.excitement { background: #ff5ec4; }
  .legend .swatch.stress { background: #ff6b6b; }

    .leaflet-container { background: #0d0f14; }
    .leaflet-popup-content { color: #111; }

  /* utilities */
  .mt6 { margin-top: 6px; }
  .mt8 { margin-top: 8px; }
  .hidden { display: none; }
  </style>
  <meta name="description" content="Client-side emotion map demo on GitHub Pages (no server, no external APIs)." />
  <meta name="robots" content="index,follow" />
  <meta name="referrer" content="no-referrer" />
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://tile.openstreetmap.org" />
  <link rel="icon" href="data:," />
  <!-- Simple privacy note: No analytics, no cookies. -->
</head>
<body>
  <div class="app">
    <header>
      <h1>EMOTERRAIN — Tokushima Awa Odori Area</h1>
      <div class="status" id="status">Loading…</div>
    </header>

    <aside class="sidebar">
      <div class="card">
        <h2>Emotion filter</h2>
        <div class="filters" id="filterButtons">
          <button data-emotion="all" class="active">All</button>
          <button data-emotion="joy">joy</button>
          <button data-emotion="calm">calm</button>
          <button data-emotion="excitement">excitement</button>
          <button data-emotion="stress">stress</button>
        </div>
      </div>

      <div class="card">
        <h2>Layer opacity</h2>
        <div class="range">
          <input id="opacityRange" type="range" min="0.2" max="1" step="0.05" value="0.75" aria-label="Layer opacity" title="Layer opacity" />
          <div class="value" id="opacityValue">0.75</div>
        </div>
        <div class="notice mt6">OSM tiles © OpenStreetMap contributors</div>
      </div>

      <div class="card" id="infoCard">
        <h2>Info</h2>
        <div class="notice">Features: <span id="featCount">0</span> shown</div>
        <div class="loading mt6" id="loadingMsg">Waiting for data…</div>
        <div class="error mt6 hidden" id="errorMsg"></div>
        <div class="legend">
          <div class="item"><span class="swatch joy"></span>joy</div>
          <div class="item"><span class="swatch calm"></span>calm</div>
          <div class="item"><span class="swatch excitement"></span>excitement</div>
          <div class="item"><span class="swatch stress"></span>stress</div>
        </div>
      </div>
    </aside>

    <main id="map"></main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ————— Config —————
    const FALLBACK_VIEW = { center: [34.0700, 134.5550], zoom: 14 };

    // Embedded data (no external file needed)
    const EMBEDDED_DATA = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [134.554548, 34.072042],
                [134.553192, 34.072633],
                [134.552611, 34.071727],
                [134.55387, 34.07148],
                [134.55389, 34.071947],
                [134.554548, 34.072042]
              ]
            ]
          },
          "properties": {
            "id": 1,
            "name": "一番町",
            "area": 11734.743,
            "population": 47,
            "households": 16,
            "emotions": {
              "joy": 60.60364268526062,
              "calm": 59.793322070926784,
              "excitement": 68.76852760893352,
              "stress": 39.93824886463105
            },
            "analysis": {
              "primary": "excitement",
              "intensity": 69
            },
            "metrics": {
              "electricity": 12000,
              "gas": 8000,
              "water": 5000,
              "land": 20000,
              "security": 4.5
            }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [134.548165, 34.078366],
                [134.54766, 34.078635],
                [134.547343, 34.078027],
                [134.547867, 34.077822],
                [134.548165, 34.078366]
              ]
            ]
          },
          "properties": {
            "id": 2,
            "name": "北出来島町１丁目",
            "area": 3781.394,
            "population": 24,
            "households": 13,
            "emotions": {
              "joy": 78.61154272923471,
              "calm": 66.53709861771321,
              "excitement": 81.75004165562227,
              "stress": 27.728665835716487
            },
            "analysis": {
              "primary": "excitement",
              "intensity": 82
            },
            "metrics": {
              "electricity": 11000,
              "gas": 8500,
              "water": 4800,
              "land": 21000,
              "security": 3.8
            }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [134.548165, 34.078366],
                [134.548634, 34.078136],
                [134.548885, 34.078521],
                [134.547968, 34.078951],
                [134.545808, 34.08],
                [134.544535, 34.08],
                [134.544611, 34.079756],
                [134.544983, 34.079924],
                [134.54556, 34.079123],
                [134.54652, 34.078424],
                [134.547228, 34.077873],
                [134.547343, 34.078027],
                [134.54766, 34.078635],
                [134.548165, 34.078366]
              ]
            ]
          },
          "properties": {
            "id": 3,
            "name": "北出来島町２丁目",
            "area": 36828.506,
            "population": 111,
            "households": 49,
            "emotions": {
              "joy": 77.1072969238997,
              "calm": 73.79525354359032,
              "excitement": 84.63888363031813,
              "stress": 30.138645863141505
            },
            "analysis": {
              "primary": "excitement",
              "intensity": 85
            },
            "metrics": {
              "electricity": 11500,
              "gas": 8200,
              "water": 5100,
              "land": 20500,
              "security": 4.2
            }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [134.55387, 34.07148],
                [134.553898, 34.070803],
                [134.554593, 34.070762],
                [134.554595, 34.071493],
                [134.555418, 34.071538],
                [134.55509, 34.072154],
                [134.554548, 34.072042],
                [134.55389, 34.071947],
                [134.55387, 34.07148]
              ]
            ]
          },
          "properties": {
            "id": 4,
            "name": "幸町１丁目",
            "area": 12999.087,
            "population": 73,
            "households": 34,
            "emotions": {
              "joy": 68.62167005965202,
              "calm": 73.39646085326441,
              "excitement": 59.608073233139535,
              "stress": 14.433020141297014
            },
            "analysis": {
              "primary": "calm",
              "intensity": 73
            },
            "metrics": {
              "electricity": 11800,
              "gas": 8300,
              "water": 4950,
              "land": 20800,
              "security": 4.0
            }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [
              [
                [134.553898, 34.070803],
                [134.553871, 34.070006],
                [134.55385, 34.06957],
                [134.555953, 34.06967],
                [134.555418, 34.071538],
                [134.554595, 34.071493],
                [134.554593, 34.070762],
                [134.553898, 34.070803]
              ]
            ]
          },
          "properties": {
            "id": 5,
            "name": "幸町２丁目",
            "area": 31306.305,
            "population": 30,
            "households": 12,
            "emotions": {
              "joy": 78.14843138000155,
              "calm": 70.02825839124506,
              "excitement": 71.42486626447112,
              "stress": 29.128336670925464
            },
            "analysis": {
              "primary": "joy",
              "intensity": 78
            },
            "metrics": {
              "electricity": 12200,
              "gas": 8100,
              "water": 5050,
              "land": 20200,
              "security": 4.7
            }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.555953, 34.06967], [134.556405, 34.067104], [134.557129, 34.067034], [134.557314, 34.067986], [134.55762, 34.069257], [134.559046, 34.069063], [134.559439, 34.071535], [134.558075, 34.071614], [134.557921, 34.070415], [134.55658, 34.070465], [134.556721, 34.071604], [134.555418, 34.071538], [134.555953, 34.06967]
            ]]
          },
          "properties": {
            "id": 8,
            "name": "新蔵町１丁目",
            "emotions": { "joy": 71.3, "calm": 60.9, "excitement": 83.3, "stress": 30.8 },
            "analysis": { "primary": "excitement", "intensity": 83 },
            "metrics": { "electricity": 11900, "gas": 8400, "water": 4900, "land": 21200, "security": 4.3 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.559046, 34.069063], [134.559042, 34.069048], [134.560374, 34.06886], [134.560347, 34.070959], [134.560332, 34.071479], [134.559439, 34.071535], [134.559046, 34.069063]
            ]]
          },
          "properties": {
            "id": 9,
            "name": "新蔵町２丁目",
            "emotions": { "joy": 77.9, "calm": 68.2, "excitement": 97.4, "stress": 33.4 },
            "analysis": { "primary": "excitement", "intensity": 97 },
            "metrics": { "electricity": 12100, "gas": 8600, "water": 5000, "land": 21500, "security": 4.6 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.560374, 34.06886], [134.562868, 34.068475], [134.562483, 34.07131], [134.561276, 34.071434], [134.561314, 34.070966], [134.560347, 34.070959], [134.560374, 34.06886]
            ]]
          },
          "properties": {
            "id": 10,
            "name": "新蔵町３丁目",
            "emotions": { "joy": 70.3, "calm": 57.3, "excitement": 93.5, "stress": 41.8 },
            "analysis": { "primary": "excitement", "intensity": 93 },
            "metrics": { "electricity": 11700, "gas": 8300, "water": 4800, "land": 21000, "security": 4.1 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.548165, 34.078366], [134.54766, 34.078635], [134.547343, 34.078027], [134.547867, 34.077822], [134.548165, 34.078366]
            ]]
          },
          "properties": {
            "id": 11,
            "name": "出来島本町１丁目",
            "emotions": { "joy": 65.8, "calm": 75.6, "excitement": 59.6, "stress": 20.4 },
            "analysis": { "primary": "calm", "intensity": 76 },
            "metrics": { "electricity": 11600, "gas": 8200, "water": 4700, "land": 20900, "security": 4.0 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.550511, 34.073649], [134.549777, 34.073977], [134.550507, 34.075095], [134.548654, 34.07586], [134.547693, 34.074014], [134.546893, 34.073602], [134.5473, 34.073096], [134.54853, 34.071566], [134.549129, 34.071986], [134.549712, 34.072676], [134.550511, 34.073649]
            ]]
          },
          "properties": {
            "id": 12,
            "name": "寺島本町西１丁目",
            "emotions": { "joy": 74.7, "calm": 72.5, "excitement": 56.0, "stress": 11.7 },
            "analysis": { "primary": "joy", "intensity": 75 },
            "metrics": { "electricity": 12300, "gas": 8700, "water": 5200, "land": 21800, "security": 4.8 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.548634, 34.078136], [134.548051, 34.076522], [134.547571, 34.076386], [134.547586, 34.07638], [134.548654, 34.07586], [134.550507, 34.075095], [134.55346, 34.073679], [134.553774, 34.073495], [134.55509, 34.072154], [134.555418, 34.071538], [134.556721, 34.071604], [134.557053, 34.073224], [134.557599, 34.07677], [134.555417, 34.076586], [134.55397, 34.076692], [134.552065, 34.077356], [134.551132, 34.077674], [134.548885, 34.078521], [134.548634, 34.078136]
            ]]
          },
          "properties": {
            "id": 13,
            "name": "徳島町城内",
            "emotions": { "joy": 87.1, "calm": 61.6, "excitement": 95.0, "stress": 44.4 },
            "analysis": { "primary": "excitement", "intensity": 95 },
            "metrics": { "electricity": 12500, "gas": 8800, "water": 5300, "land": 22000, "security": 4.9 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.544535, 34.08], [134.54368, 34.08], [134.543437, 34.079923], [134.543956, 34.078522], [134.544827, 34.0787], [134.54556, 34.079123], [134.544983, 34.079924], [134.544611, 34.079756], [134.544535, 34.08]
            ]]
          },
          "properties": {
            "id": 14,
            "name": "東出来島町１丁目",
            "emotions": { "joy": 63.3, "calm": 70.4, "excitement": 54.2, "stress": 15.1 },
            "analysis": { "primary": "calm", "intensity": 70 },
            "metrics": { "electricity": 11300, "gas": 8000, "water": 4600, "land": 20700, "security": 3.9 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.544827, 34.0787], [134.543956, 34.078522], [134.543437, 34.079923], [134.543016, 34.079534], [134.542742, 34.078597], [134.54447, 34.077858], [134.545185, 34.078233], [134.544827, 34.0787]
            ]]
          },
          "properties": {
            "id": 15,
            "name": "東出来島町２丁目",
            "emotions": { "joy": 82.0, "calm": 58.1, "excitement": 99.7, "stress": 42.3 },
            "analysis": { "primary": "excitement", "intensity": 100 },
            "metrics": { "electricity": 12600, "gas": 8900, "water": 5400, "land": 22100, "security": 5.0 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.551, 34.075], [134.552, 34.075], [134.552, 34.076], [134.551, 34.076], [134.551, 34.075]
            ]]
          },
          "properties": {
            "id": 16,
            "name": "豊島町",
            "emotions": { "joy": 70.0, "calm": 65.0, "excitement": 80.0, "stress": 25.0 },
            "analysis": { "primary": "excitement", "intensity": 80 },
            "metrics": { "electricity": 12000, "gas": 8100, "water": 4800, "land": 21000, "security": 4.2 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.553, 34.074], [134.554, 34.074], [134.554, 34.075], [134.553, 34.075], [134.553, 34.074]
            ]]
          },
          "properties": {
            "id": 17,
            "name": "場内",
            "emotions": { "joy": 75.0, "calm": 60.0, "excitement": 85.0, "stress": 30.0 },
            "analysis": { "primary": "excitement", "intensity": 85 },
            "metrics": { "electricity": 12200, "gas": 8200, "water": 4900, "land": 21200, "security": 4.4 }
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Polygon",
            "coordinates": [[
              [134.555, 34.073], [134.556, 34.073], [134.556, 34.074], [134.555, 34.074], [134.555, 34.073]
            ]]
          },
          "properties": {
            "id": 18,
            "name": "東岸町",
            "emotions": { "joy": 80.0, "calm": 70.0, "excitement": 90.0, "stress": 20.0 },
            "analysis": { "primary": "excitement", "intensity": 90 },
            "metrics": { "electricity": 12400, "gas": 8300, "water": 5000, "land": 21500, "security": 4.6 }
          }
        }
      ]
    };

    const EMOTION_ORDER = ['joy', 'calm', 'excitement', 'stress']; // tie-breaker priority
    const COLORS = {
      joy: '#ffd94a',         // warm yellow
      calm: '#4ea0ff',        // calm blue
      excitement: '#ff5ec4',  // vivid magenta
      stress: '#ff6b6b'       // red
    };

    const INTENSITY_BY_SCORE = (score) => {
      if (score == null || isNaN(score)) return 'low';
      if (score <= 24) return 'low';
      if (score <= 49) return 'moderate';
      if (score <= 74) return 'high';
      return 'very_high';
    };

    const OPACITY_BY_INTENSITY = {
      low: 0.35,
      moderate: 0.55,
      high: 0.75,
      very_high: 0.95
    };

    // ————— State —————
    let map, baseLayer, geoLayer;
    let rawData = null; // GeoJSON FeatureCollection
    let selectedEmotion = 'all';
    let layerOpacity = 0.75;

    // ————— Init —————
    init();

    function init() {
      // Map
      map = L.map('map');
      baseLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      map.setView(FALLBACK_VIEW.center, FALLBACK_VIEW.zoom);

      // UI events
      setupUI();

      // Load data
      fetchData();
    }

    function setupUI() {
      const btns = document.querySelectorAll('#filterButtons button');
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          btns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedEmotion = btn.getAttribute('data-emotion');
          renderLayer();
        });
      });

      const range = document.getElementById('opacityRange');
      const val = document.getElementById('opacityValue');
      range.addEventListener('input', () => {
        layerOpacity = parseFloat(range.value);
        val.textContent = range.value;
        applyOpacity();
      });
    }

    async function fetchData() {
      setStatus('Loading data…');
      setLoading(true);
      setError(null);
      try {
        // Use embedded data instead of fetch
        const data = EMBEDDED_DATA;

        if (!data || data.type !== 'FeatureCollection' || !Array.isArray(data.features)) {
          throw new Error('Invalid GeoJSON: FeatureCollection expected');
        }

        // Derive primary/intensity if missing
        data.features.forEach(f => {
          const props = f.properties || (f.properties = {});
          const emotions = props.emotions || {};
          if (!props.analysis) props.analysis = {};
          if (!props.analysis.primary) props.analysis.primary = computePrimary(emotions);
          if (!props.analysis.intensity) {
            const s = emotions[props.analysis.primary];
            props.analysis.intensity = INTENSITY_BY_SCORE(s);
          }
        });

        rawData = data;
        renderLayer();
        fitToData();
        setStatus('Ready');
      } catch (err) {
        console.error(err);
        setError(err.message || String(err));
        setStatus('Error');
      } finally {
        setLoading(false);
      }
    }

    function computePrimary(emotions) {
      let best = 'joy';
      let bestVal = -Infinity;
      EMOTION_ORDER.forEach(k => {
        const v = Number(emotions?.[k] ?? -Infinity);
        if (v > bestVal || (v === bestVal && EMOTION_ORDER.indexOf(k) < EMOTION_ORDER.indexOf(best))) {
          best = k; bestVal = v;
        }
      });
      return best;
    }

    function styleForFeature(feature) {
      const { analysis } = feature.properties || {};
      const primary = analysis?.primary || 'joy';
      const intensity = analysis?.intensity || 'low';
      const base = COLORS[primary] || '#888';
      const op = Math.min(1, Math.max(0, OPACITY_BY_INTENSITY[intensity] ?? 0.5) * layerOpacity);
      return {
        color: '#ffffff',
        weight: 0.8,
        opacity: 0.9,
        fillColor: base,
        fillOpacity: op
      };
    }

    function featureFilter(feature) {
      if (selectedEmotion === 'all') return true;
      const p = feature.properties?.analysis?.primary;
      return p === selectedEmotion;
    }

    function popupForFeature(feature, layer) {
      const p = feature.properties || {};
      const a = p.analysis || {};
      const e = p.emotions || {};
      const m = p.metrics || {};
      const name = p.name || p.id || 'Area';
      const html = `
        <div style="min-width:220px">
          <div style="font-weight:600;margin-bottom:4px">${escapeHtml(name)}</div>
          <div style="margin-bottom:6px;font-size:13px">
            primary: <b>${escapeHtml(a.primary || '-')}</b> &nbsp; intensity: <b>${escapeHtml(a.intensity || '-')}</b>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:4px;font-size:12px">
            <div>joy: ${fmt(e.joy)}</div>
            <div>calm: ${fmt(e.calm)}</div>
            <div>excitement: ${fmt(e.excitement)}</div>
            <div>stress: ${fmt(e.stress)}</div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:#888">
            <b>電気代:</b> ${fmt(m.electricity)} 円<br>
            <b>ガス代:</b> ${fmt(m.gas)} 円<br>
            <b>水道代:</b> ${fmt(m.water)} 円<br>
            <b>地代:</b> ${fmt(m.land)} 円<br>
            <b>治安:</b> ${fmt(m.security)}
          </div>
        </div>`;
      layer.bindPopup(html);
    }

    function fmt(v){ return (v==null || isNaN(v)) ? '-' : Number(v).toFixed(0); }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }

    function renderLayer() {
      if (!rawData) return;
      if (geoLayer) { geoLayer.remove(); geoLayer = null; }
      const shown = [];
      geoLayer = L.geoJSON(rawData, {
        style: styleForFeature,
        filter: (f) => {
          const ok = featureFilter(f);
          if (ok) shown.push(f);
          return ok;
        },
        onEachFeature: (f, layer) => popupForFeature(f, layer)
      }).addTo(map);
      document.getElementById('featCount').textContent = String(shown.length);
    }

    function applyOpacity() {
      if (!geoLayer) return;
      // Reapply style with updated global opacity multiplier
      geoLayer.setStyle(styleForFeature);
    }

    function fitToData() {
      try {
        if (!rawData || !rawData.features?.length) return;
        const bounds = L.geoJSON(rawData).getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        } else {
          map.setView(FALLBACK_VIEW.center, FALLBACK_VIEW.zoom);
        }
      } catch(e){
        map.setView(FALLBACK_VIEW.center, FALLBACK_VIEW.zoom);
      }
    }

    function setStatus(text){ const el = document.getElementById('status'); if (el) el.textContent = text; }
    function setLoading(on){ const el = document.getElementById('loadingMsg'); if (!el) return; el.style.display = on ? 'block' : 'none'; }
    function setError(msg){ const el = document.getElementById('errorMsg'); if (!el) return; if (!msg){ el.style.display='none'; el.textContent=''; } else { el.style.display='block'; el.textContent = msg; } }
  </script>
</body>
</html>
