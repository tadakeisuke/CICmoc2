<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMOTERRAIN - å¾³å³¶å¸‚æ„Ÿæƒ…ãƒãƒƒãƒ—ï¼ˆé˜¿æ³¢è¸Šã‚Šæ¼”èˆå ´ã‚¨ãƒªã‚¢ï¼‰</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cyber-cyan: #06b6d4;
      --cyber-blue: #3b82f6;
      --cyber-purple: #8b5cf6;
      --sidebar-bg: rgba(26,26,46,0.95);
      --panel-bg: rgba(26,26,46,0.95);
      --border-cyan: rgba(6,182,212,0.3);
      --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-mono);
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: #fff;
      min-height: 100vh;
      overflow: hidden;
    }
    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .header {
      border-bottom: 1px solid var(--border-cyan);
      padding-bottom: 15px;
      margin-bottom: 10px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .logo-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-weight: bold; font-size: 20px;
    }
    .logo-text {
      font-size: 18px; font-weight: bold;
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue), var(--cyber-purple));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { font-size: 12px; color: var(--cyber-cyan); }
    .timestamp { font-size: 11px; color: #9ca3af; }
    .section-title {
      font-size: 14px; font-weight: bold; color: var(--cyber-cyan);
      margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .emotion-filters { display: flex; flex-direction: column; gap: 8px; }
    .emotion-btn {
      padding: 10px 12px;
      border: 1px solid var(--border-cyan);
      background: rgba(55,65,81,0.5);
      color: var(--cyber-cyan);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; gap: 10px;
      font-size: 12px; font-weight: bold;
    }
    .emotion-btn:hover { background: rgba(75,85,99,0.5); border-color: rgba(6,182,212,0.5);}
    .emotion-btn.active {
      background: linear-gradient(135deg, var(--cyber-cyan), var(--cyber-blue));
      color: #222; border-color: var(--cyber-cyan);
    }
    .layer-controls, .stats-panel {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .control-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .control-label { font-size: 11px; color: #9ca3af; }
    .toggle-btn {
      padding: 4px 8px;
      border: 1px solid var(--border-cyan);
      background: rgba(75,85,99,0.5);
      color: #9ca3af;
      border-radius: 4px;
      cursor: pointer; font-size: 10px; transition: all 0.2s;
    }
    .toggle-btn.active { background: rgba(6,182,212,0.2); color: var(--cyber-cyan);}
    .opacity-slider {
      width: 100%; height: 4px; background: #374151;
      border-radius: 2px; outline: none; cursor: pointer;
    }
    .stat-item {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; font-size: 11px;
    }
    .stat-label { color: #9ca3af; }
    .stat-value { color: var(--cyber-cyan); font-weight: bold; }
    .emotion-indicator {
      width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; display: inline-block;
    }
    .map-container {
      flex: 1; position: relative;
      min-width: 0;
    }
    
    /* åœ°å›³ç›´æ¥è‰²å¡—ã‚Šç”¨CSS */
    .leaflet-interactive {
      mix-blend-mode: multiply;  /* åœ°å›³ã‚¿ã‚¤ãƒ«ã¨ã®è‰²åˆæˆ */
    }
    
    .leaflet-overlay-pane svg {
      pointer-events: auto;
    }
    
    /* åœ°å›³ä¸€ä½“åŒ–ç”¨ã®å¢ƒç•Œç·šã‚¹ã‚¿ã‚¤ãƒ« - ã‚ˆã‚Šç²¾å¯†ã§è‡ªç„¶ãªè¡¨ç¾ */
    path.leaflet-interactive {
      stroke-linecap: round;
      stroke-linejoin: round;
      vector-effect: non-scaling-stroke; /* ã‚ºãƒ¼ãƒ æ™‚ã®ç·šå¹…ã‚’ä¸€å®šã«ä¿æŒ */
    }
    
    /* OpenStreetMapã¨ã®å¢ƒç•Œç·šèª¿å’Œ */
    .leaflet-overlay-pane path {
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); /* å¾®ç´°ãªå½±åŠ¹æœ */
    }
    
    #map { height: 100%; width: 100%; }
    .leaflet-popup-content-wrapper {
      background: var(--panel-bg);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
    }
    .leaflet-popup-content {
      color: #fff; font-family: var(--font-mono); margin: 15px;
    }
    .leaflet-popup-tip {
      background: var(--panel-bg);
      border: 1px solid var(--border-cyan);
    }
    .popup-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .popup-section { margin-bottom: 12px;}
    .popup-label { font-size: 11px; color: #9ca3af; margin-bottom: 5px;}
    .popup-value { font-size: 12px; color: #fff; font-weight: bold;}
    .emotion-score {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 5px; font-size: 11px;
    }
    .feature-tag {
      display: inline-block;
      background: rgba(6,182,212,0.2);
      color: var(--cyber-cyan);
      padding: 2px 6px; border-radius: 4px; margin-right: 4px;
      font-size: 11px;
    }
    .details-panel {
      width: 340px;
      background: var(--panel-bg);
      border-left: 1px solid var(--border-cyan);
      padding: 20px;
      overflow-y: auto;
      z-index: 1000;
      display: flex; flex-direction: column; gap: 16px;
    }
    .details-title { font-size: 16px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 10px;}
    .no-selection {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; color: #9ca3af; gap: 10px;
    }
    .no-selection-icon { font-size: 32px; color: var(--cyber-cyan);}
    .no-selection-text { font-size: 13px;}
    .info-box {
      background: rgba(55,65,81,0.5);
      border: 1px solid var(--border-cyan);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .info-title { font-size: 13px; font-weight: bold; color: var(--cyber-cyan); margin-bottom: 8px;}
    .info-item { font-size: 12px; margin-bottom: 6px;}
    @media (max-width: 1024px) {
      .sidebar { width: 220px; padding: 10px;}
      .details-panel { width: 220px; padding: 10px;}
    }
    @media (max-width: 768px) {
      .container { flex-direction: column;}
      .sidebar, .details-panel { width: 100vw; min-width: 0; border: none; border-bottom: 1px solid var(--border-cyan);}
      .sidebar { order: 1;}
      .map-container { order: 2; min-height: 300px;}
      .details-panel { order: 3;}
    }
    @media (max-width: 480px) {
      .sidebar, .details-panel { padding: 6px;}
      .header { padding-bottom: 8px;}
      .logo-text { font-size: 15px;}
      .details-title { font-size: 13px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="header">
        <div class="logo">
          <div class="logo-icon"><i class="fa-solid fa-brain"></i></div>
          <div class="logo-text">EMOTERRAIN</div>
        </div>
        <div class="subtitle">å¾³å³¶å¸‚æ„Ÿæƒ…ãƒãƒƒãƒ— - é˜¿æ³¢è¸Šã‚Šã‚¨ãƒªã‚¢</div>
        <div class="timestamp" id="timestamp"></div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-info-circle"></i> ãƒ‡ãƒ¼ã‚¿ä»•æ§˜</div>
        <div style="font-size:11px; color:#9ca3af; margin-bottom:15px; line-height:1.4;">
          <strong>å›½åœŸæ•°å€¤æƒ…å ±æº–æ‹ </strong><br>
          å®Ÿéš›ã®è¡Œæ”¿åŒºç”»å¢ƒç•Œã«åŸºã¥ãç”ºãƒ»å­—å˜ä½ã®æ„Ÿæƒ…ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã€‚OpenStreetMapã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ã¨å¢ƒç•Œç·šãŒä¸€è‡´ã—ãŸç²¾å¯†ãªåŒºç”»åˆ†æã€‚
        </div>
      </div>
      <div>
        <div class="section-title"><i class="fa-solid fa-filter"></i> æ„Ÿæƒ…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
        <div class="emotion-filters" id="emotion-filters"></div>
      </div>
      <div class="layer-controls">
        <div class="control-item">
          <span class="control-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span>
          <select id="display-mode" title="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰é¸æŠ" style="padding:4px 8px;border:1px solid rgba(6,182,212,0.3);background:rgba(75,85,99,0.5);color:#06b6d4;border-radius:4px;font-size:11px;">
            <option value="boundary">å¢ƒç•Œç·šè¡¨ç¤º</option>
            <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</option>
          </select>
        </div>
        <div class="control-item">
          <span class="control-label">æ„Ÿæƒ…ãƒ¬ã‚¤ãƒ¤ãƒ¼</span>
          <button class="toggle-btn active" id="layer-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">ãƒ©ãƒ™ãƒ«è¡¨ç¤º</span>
          <button class="toggle-btn active" id="label-toggle">ON</button>
        </div>
        <div class="control-item">
          <span class="control-label">é€æ˜åº¦</span>
        </div>
        <input type="range" min="0.2" max="1" step="0.01" value="0.7" class="opacity-slider" id="opacity-slider" title="é€æ˜åº¦èª¿æ•´">
      </div>
      <div class="stats-panel" id="stats-panel"></div>
    </div>
    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      <div style="position:absolute;bottom:8px;right:12px;z-index:999;font-size:11px;background:rgba(26,26,46,0.7);padding:4px 10px;border-radius:6px;">
        Â© <a href="https://openstreetmap.org" target="_blank" rel="noopener" style="color:#06b6d4;text-decoration:underline;">OpenStreetMap</a> contributors
      </div>
    </div>
    <!-- Right Details Panel -->
    <div class="details-panel" id="details-panel"></div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // æ„Ÿæƒ…ã‚«ãƒ©ãƒ¼ï¼ˆå¼·åº¦åˆ¥ï¼‰
    const emotionColors = {
      joy: {
        low: (opacity) => `rgba(34,197,94,${opacity * 0.4})`,      // è–„ã„ç·‘
        medium: (opacity) => `rgba(34,197,94,${opacity * 0.7})`,   // ä¸­ç·‘
        high: (opacity) => `rgba(34,197,94,${opacity})`,           // æ¿ƒã„ç·‘
        veryHigh: (opacity) => `rgba(21,128,61,${opacity})`        // éå¸¸ã«æ¿ƒã„ç·‘
      },
      calm: {
        low: (opacity) => `rgba(59,130,246,${opacity * 0.4})`,     // è–„ã„é’
        medium: (opacity) => `rgba(59,130,246,${opacity * 0.7})`,  // ä¸­é’
        high: (opacity) => `rgba(59,130,246,${opacity})`,          // æ¿ƒã„é’
        veryHigh: (opacity) => `rgba(37,99,235,${opacity})`        // éå¸¸ã«æ¿ƒã„é’
      },
      excitement: {
        low: (opacity) => `rgba(245,158,11,${opacity * 0.4})`,     // è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸
        medium: (opacity) => `rgba(245,158,11,${opacity * 0.7})`,  // ä¸­ã‚ªãƒ¬ãƒ³ã‚¸
        high: (opacity) => `rgba(245,158,11,${opacity})`,          // æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸
        veryHigh: (opacity) => `rgba(217,119,6,${opacity})`        // éå¸¸ã«æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸
      },
      stress: {
        low: (opacity) => `rgba(239,68,68,${opacity * 0.4})`,      // è–„ã„èµ¤
        medium: (opacity) => `rgba(239,68,68,${opacity * 0.7})`,   // ä¸­èµ¤
        high: (opacity) => `rgba(239,68,68,${opacity})`,           // æ¿ƒã„èµ¤
        veryHigh: (opacity) => `rgba(185,28,28,${opacity})`        // éå¸¸ã«æ¿ƒã„èµ¤
      }
    };
    // å¾³å³¶å¸‚é˜¿æ³¢è¸Šã‚Šæ¼”èˆå ´å‘¨è¾ºåŒºç”»GeoJSONï¼ˆå›½åœŸäº¤é€šçœãƒ»e-Statå…¬å¼ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ï¼‰
    // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼šå›½åœŸäº¤é€šçœ å›½åœŸæ•°å€¤æƒ…å ±ï¼ˆè¡Œæ”¿åŒºåŸŸãƒ‡ãƒ¼ã‚¿ï¼‰
    // ã€Œä»¤å’Œ5å¹´å…¨å›½éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘åˆ¥é¢ç©èª¿ã€ï¼ˆå›½åœŸåœ°ç†é™¢ï¼‰ã‚’åŠ å·¥
    
    // KMLãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŒ‡å®šç”ºåŸŸã®GeoJSONã‚’ç”Ÿæˆ
    const loadKMLDataToGeoJSON = async () => {
      try {
        // å¯¾è±¡ç”ºåŸŸã®å®šç¾©ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸ8ç”ºåŸŸï¼‰
        const targetDistricts = [
          'ä¸¡å›½æœ¬ç”º', 'å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®', 'å¯ºå³¶æœ¬ç”ºè¥¿ï¼’ä¸ç›®', 'å¯ºå³¶æœ¬ç”ºæ±ï¼‘ä¸ç›®', 
          'å¯ºå³¶æœ¬ç”ºæ±ï¼’ä¸ç›®', 'å—å†…ç”ºï¼‘ä¸ç›®', 'ä¸€ç•ªç”º', 'ç± å±‹ç”ºï¼‘ä¸ç›®', 'ç± å±‹ç”ºï¼’ä¸ç›®',
          'æ±èˆ¹å ´ç”ºï¼‘ä¸ç›®', 'æ±èˆ¹å ´ç”ºï¼’ä¸ç›®', 'è¥¿èˆ¹å ´ç”ºï¼“ä¸ç›®', 'è¥¿èˆ¹å ´ç”ºï¼•ä¸ç›®',
          'å…«ç™¾å±‹ç”º' // ç´ºå±‹ç”ºã®ä»£ã‚ã‚Šã«è¿‘æ¥ã™ã‚‹ç”ºåŸŸã¨ã—ã¦
        ];

        // KMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆå‚è€ƒãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ï¼‰
        const response = await fetch('./å‚è€ƒ/1755581695189.kml');
        const kmlText = await response.text();
        const parser = new DOMParser();
        const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
        
        console.log('KMLè§£æé–‹å§‹...');
        const placemarks = kmlDoc.querySelectorAll('Placemark');
        const features = [];
        let processedCount = 0;
        
        console.log(`ç·Placemarkæ•°: ${placemarks.length}`);

        for (let i = 0; i < placemarks.length; i++) {
          const placemark = placemarks[i];
          const nameElement = placemark.querySelector('name');
          
          if (nameElement) {
            const districtName = nameElement.textContent.trim();
            
            // å¯¾è±¡ç”ºåŸŸã®ãƒã‚§ãƒƒã‚¯ï¼ˆéƒ¨åˆ†ä¸€è‡´ã‚‚å«ã‚€ï¼‰
            const isTargetDistrict = targetDistricts.some(target => 
              districtName.includes(target) || target.includes(districtName)
            );
            
            if (isTargetDistrict) {
              console.log(`å¯¾è±¡ç”ºåŸŸç™ºè¦‹: ${districtName}`);
              const feature = convertPlacemarkToGeoJSON(placemark);
              
              if (feature) {
                // ExtendedDataã‹ã‚‰çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—
                const schemaData = placemark.querySelector('ExtendedData SchemaData');
                const statisticsData = {};
                
                if (schemaData) {
                  const simpleDataElements = schemaData.querySelectorAll('SimpleData');
                  simpleDataElements.forEach(dataElement => {
                    const nameAttr = dataElement.getAttribute('name');
                    const value = dataElement.textContent.trim();
                    if (nameAttr && value) {
                      statisticsData[nameAttr] = value;
                    }
                  });
                  console.log(`${districtName}ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿:`, statisticsData);
                }
                
                // æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                const emotionData = generateEmotionDataForDistrict(districtName, statisticsData);
                
                // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’çµ±åˆ
                feature.properties = {
                  ...feature.properties,
                  type: getDistrictType(districtName),
                  features: getDistrictFeatures(districtName),
                  statistics: statisticsData,
                  emotions: emotionData.emotions,
                  incidents: emotionData.incidents,
                  analysis: emotionData.analysis,
                  population: parseInt(statisticsData.JINKO) || 0,
                  households: parseInt(statisticsData.SETAI) || 0,
                  area: parseFloat(statisticsData.AREA) || 0
                };
                
                features.push(feature);
                processedCount++;
                console.log(`å‡¦ç†å®Œäº†: ${districtName} (${processedCount}ä»¶ç›®)`);
              }
            }
          }
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤ºï¼ˆ1000ä»¶ã”ã¨ï¼‰
          if (i % 1000 === 0 && i > 0) {
            console.log(`KMLå‡¦ç†é€²æ—: ${i}/${placemarks.length} (${(i/placemarks.length*100).toFixed(1)}%)`);
          }
        }

        console.log(`âœ… KMLå‡¦ç†å®Œäº†: ${processedCount}ä»¶ã®ç”ºåŸŸã‚’æŠ½å‡º`);
        console.log('æŠ½å‡ºã•ã‚ŒãŸç”ºåŸŸ:', features.map(f => f.properties.name));

        return {
          type: "FeatureCollection",
          features: features,
          metadata: {
            source: 'jSTAT MAP KML Data',
            processed: new Date().toISOString(),
            totalFeatures: processedCount,
            originalPlacemarks: placemarks.length
          }
        };

      } catch (error) {
        console.warn('KMLãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨:', error);
        return getFallbackGeoJSON();
      }
    };

    // Placemarkã‚’GeoJSON Featureã«å¤‰æ›ï¼ˆKMLçµ±åˆç‰ˆï¼‰
    const convertPlacemarkToGeoJSON = (placemark) => {
      try {
        const nameElement = placemark.querySelector('name');
        if (!nameElement) {
          console.warn('Placemarkã«åå‰ãŒã‚ã‚Šã¾ã›ã‚“');
          return null;
        }

        const districtName = nameElement.textContent.trim();
        console.log(`å‡¦ç†ä¸­ã®ç”ºåŸŸ: ${districtName}`);

        // MultiGeometry ã¾ãŸã¯ Polygon ã‚’æ¢ã™
        let coordinatesArray = [];
        
        // MultiGeometryå†…ã®Polygonã‚’å‡¦ç†
        const multiGeometry = placemark.querySelector('MultiGeometry');
        if (multiGeometry) {
          const polygons = multiGeometry.querySelectorAll('Polygon');
          console.log(`${districtName}: MultiGeometryå†…ã«${polygons.length}å€‹ã®Polygonã‚’ç™ºè¦‹`);
          
          polygons.forEach((polygon, index) => {
            const outerBoundary = polygon.querySelector('outerBoundaryIs LinearRing coordinates');
            if (outerBoundary) {
              const coords = parseKMLCoordinates(outerBoundary.textContent);
              if (coords && coords.length >= 3) {
                coordinatesArray.push(coords);
                console.log(`  Polygon ${index + 1}: ${coords.length}å€‹ã®åº§æ¨™ç‚¹`);
              }
            }
          });
        } else {
          // å˜ä¸€ã®Polygonã‚’å‡¦ç†
          const polygon = placemark.querySelector('Polygon');
          if (polygon) {
            const outerBoundary = polygon.querySelector('outerBoundaryIs LinearRing coordinates');
            if (outerBoundary) {
              const coords = parseKMLCoordinates(outerBoundary.textContent);
              if (coords && coords.length >= 3) {
                coordinatesArray.push(coords);
                console.log(`${districtName}: å˜ä¸€Polygonã€${coords.length}å€‹ã®åº§æ¨™ç‚¹`);
              }
            }
          }
        }

        if (coordinatesArray.length === 0) {
          console.warn(`${districtName}: æœ‰åŠ¹ãªåº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
          return null;
        }

        // GeoJSON Featureä½œæˆ
        const geometry = coordinatesArray.length === 1 ? {
          type: "Polygon",
          coordinates: coordinatesArray
        } : {
          type: "MultiPolygon", 
          coordinates: coordinatesArray.map(coords => [coords])
        };

        return {
          type: "Feature",
          geometry: geometry,
          properties: {
            name: districtName,
            coordinateCount: coordinatesArray.reduce((total, coords) => total + coords.length, 0)
          }
        };

      } catch (error) {
        console.error('Placemarkå¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    };

    // KMLåº§æ¨™æ–‡å­—åˆ—ã‚’è§£æ
    const parseKMLCoordinates = (coordinatesText) => {
      try {
        return coordinatesText.trim()
          .split(/\s+/)
          .map(coord => {
            const parts = coord.trim().split(',');
            if (parts.length >= 2) {
              const lng = parseFloat(parts[0]);
              const lat = parseFloat(parts[1]);
              if (!isNaN(lng) && !isNaN(lat)) {
                return [lng, lat];
              }
            }
            return null;
          })
          .filter(coord => coord !== null);
      } catch (error) {
        console.error('åº§æ¨™è§£æã‚¨ãƒ©ãƒ¼:', error);
        return [];
      }
    };

    // ç”ºåŸŸåã«åŸºã¥ãæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const generateEmotionDataForDistrict = (districtName, data) => {
      const population = parseInt(data.JINKO) || 50;
      const area = parseFloat(data.AREA) / 1000000 || 0.1;
      const density = population / area;

      // ç”ºåŸŸã®ç‰¹æ€§ã«ã‚ˆã‚‹æ„Ÿæƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³
      let baseEmotions = {};
      let primaryEmotion = 'calm';
      let intensity = 'ä¸­ç¨‹åº¦';
      
      if (districtName.includes('ä¸¡å›½æœ¬ç”º')) {
        // é˜¿æ³¢è¸Šã‚Šã®ä¸­å¿ƒåœ° - é«˜ã„èˆˆå¥®åº¦ã¨å–œã³
        baseEmotions = { joy: 85, calm: 45, excitement: 90, stress: 40 };
        primaryEmotion = 'excitement';
        intensity = 'éå¸¸ã«é«˜';
      } else if (districtName.includes('å¯ºå³¶æœ¬ç”º')) {
        // ãƒ“ã‚¸ãƒã‚¹ãƒ»ä½å®…åœ° - ãƒãƒ©ãƒ³ã‚¹å‹
        baseEmotions = { joy: 65, calm: 70, excitement: 60, stress: 45 };
        primaryEmotion = 'calm';
        intensity = 'ä¸­ç¨‹åº¦';
      } else if (districtName.includes('ä¸€ç•ªç”º')) {
        // å•†æ¥­ä¸­å¿ƒåœ° - æ´»æ°—ã¨è»½åº¦ã‚¹ãƒˆãƒ¬ã‚¹
        baseEmotions = { joy: 75, calm: 55, excitement: 80, stress: 55 };
        primaryEmotion = 'excitement';
        intensity = 'é«˜';
      } else if (districtName.includes('å—å†…ç”º')) {
        // ä½å®…åœ° - è½ã¡ç€ãã¨å¹³ç©
        baseEmotions = { joy: 60, calm: 80, excitement: 45, stress: 35 };
        primaryEmotion = 'calm';
        intensity = 'é«˜';
      } else if (districtName.includes('ç± å±‹ç”º') || districtName.includes('å…«ç™¾å±‹ç”º')) {
        // ä¼çµ±å•†æ¥­åœ° - ä¸­ç¨‹åº¦ã®æ´»æ°—
        baseEmotions = { joy: 70, calm: 60, excitement: 70, stress: 50 };
        primaryEmotion = 'joy';
        intensity = 'ä¸­ç¨‹åº¦';
      } else if (districtName.includes('èˆ¹å ´ç”º')) {
        // æ¸¯æ¹¾ãƒ»å•†æ¥­åœ° - æ´»ç™ºãªçµŒæ¸ˆæ´»å‹•
        baseEmotions = { joy: 72, calm: 52, excitement: 75, stress: 58 };
        primaryEmotion = 'excitement';
        intensity = 'é«˜';
      } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        baseEmotions = { joy: 60, calm: 65, excitement: 55, stress: 45 };
        primaryEmotion = 'calm';
      }

      // äººå£å¯†åº¦ã«ã‚ˆã‚‹èª¿æ•´
      if (density > 2000) {
        baseEmotions.stress += 10;
        baseEmotions.excitement += 5;
      } else if (density < 500) {
        baseEmotions.calm += 10;
        baseEmotions.stress -= 5;
      }

      // ç¯„å›²åˆ¶é™
      Object.keys(baseEmotions).forEach(key => {
        baseEmotions[key] = Math.max(0, Math.min(100, baseEmotions[key]));
      });

      return {
        emotions: baseEmotions,
        incidents: {
          total: Math.floor(population / 5) + Math.floor(Math.random() * 10),
          joy: Math.floor(baseEmotions.joy / 10),
          calm: Math.floor(baseEmotions.calm / 10),
          excitement: Math.floor(baseEmotions.excitement / 10),
          stress: Math.floor(baseEmotions.stress / 10)
        },
        analysis: {
          primary: primaryEmotion,
          intensity: intensity,
          factors: getDistrictFactors(districtName),
          recommendations: getDistrictRecommendations(districtName)
        }
      };
    };

    // ç”ºåŸŸã‚¿ã‚¤ãƒ—åˆ¤å®š
    const getDistrictType = (districtName) => {
      if (districtName.includes('ä¸¡å›½æœ¬ç”º')) return 'æ–‡åŒ–ãƒ»è¦³å…‰åœ°åŸŸ';
      if (districtName.includes('å¯ºå³¶æœ¬ç”º')) return 'ãƒ“ã‚¸ãƒã‚¹ãƒ»ä½å®…åœ°åŸŸ';
      if (districtName.includes('ä¸€ç•ªç”º')) return 'å•†æ¥­åœ°åŸŸ';
      if (districtName.includes('å—å†…ç”º')) return 'ä½å®…åœ°åŸŸ';
      if (districtName.includes('ç± å±‹ç”º') || districtName.includes('å…«ç™¾å±‹ç”º')) return 'ä¼çµ±å•†æ¥­åœ°åŸŸ';
      if (districtName.includes('èˆ¹å ´ç”º')) return 'æ¸¯æ¹¾ãƒ»å•†æ¥­åœ°åŸŸ';
      return 'æ··åˆåœ°åŸŸ';
    };

    // ç”ºåŸŸã®ä¸»è¦æ–½è¨­
    const getDistrictFeatures = (districtName) => {
      const features = {
        'ä¸¡å›½æœ¬ç”º': ['é˜¿æ³¢ãŠã©ã‚Šä¼šé¤¨', 'å…ƒç”ºæ¼”èˆå ´', 'è¦³å…‰æ¡ˆå†…æ‰€', 'å•†åº—è¡—'],
        'å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®': ['JRå¾³å³¶é§…', 'ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«', 'éŠ€è¡Œ', 'å•†æ¥­æ–½è¨­'],
        'å¯ºå³¶æœ¬ç”ºè¥¿ï¼’ä¸ç›®': ['å¾³å³¶é§…å‰', 'ãƒ›ãƒ†ãƒ«', 'é£²é£Ÿåº—è¡—', 'äº¤é€šæ‹ ç‚¹'],
        'å¯ºå³¶æœ¬ç”ºæ±ï¼‘ä¸ç›®': ['ä½å®…è¡—', 'å°å­¦æ ¡', 'å…¬åœ’', 'åŒ»é™¢'],
        'å¯ºå³¶æœ¬ç”ºæ±ï¼’ä¸ç›®': ['ãƒãƒ³ã‚·ãƒ§ãƒ³', 'ã‚³ãƒ³ãƒ“ãƒ‹', 'è–¬å±€', 'éƒµä¾¿å±€'],
        'ä¸€ç•ªç”º': ['å•†åº—è¡—', 'ãƒ‡ãƒ‘ãƒ¼ãƒˆ', 'ã‚«ãƒ•ã‚§', 'æ–‡åŒ–æ–½è¨­'],
        'å—å†…ç”ºï¼‘ä¸ç›®': ['ä½å®…è¡—', 'ä¿è‚²åœ’', 'å…¬æ°‘é¤¨', 'å•†åº—'],
        'ç± å±‹ç”ºï¼‘ä¸ç›®': ['è€èˆ—å•†åº—', 'ä¼çµ±å·¥èŠ¸', 'åœ°åŸŸã‚»ãƒ³ã‚¿ãƒ¼', 'å¸‚å ´'],
        'ç± å±‹ç”ºï¼’ä¸ç›®': ['å•†åº—è¡—', 'éŠ€è¡Œæ”¯åº—', 'è–¬å±€', 'é£²é£Ÿåº—'],
        'æ±èˆ¹å ´ç”ºï¼‘ä¸ç›®': ['æ¸¯æ¹¾æ–½è¨­', 'å€‰åº«è¡—', 'é‹é€ä¼šç¤¾', 'å¸‚å ´'],
        'æ±èˆ¹å ´ç”ºï¼’ä¸ç›®': ['æ¼å”', 'æ°´ç”£ä¼šç¤¾', 'å¸å£²å¸‚å ´', 'å†·è”µåº«'],
        'è¥¿èˆ¹å ´ç”ºï¼“ä¸ç›®': ['å•†æ¥­æ¸¯', 'ç‰©æµã‚»ãƒ³ã‚¿ãƒ¼', 'ã‚ªãƒ•ã‚£ã‚¹', 'å€‰åº«'],
        'è¥¿èˆ¹å ´ç”ºï¼•ä¸ç›®': ['æ¸¯æ¹¾ç®¡ç†', 'æµ·é‹ä¼šç¤¾', 'è²¿æ˜“äº‹å‹™æ‰€', 'ç¨é–¢'],
        'å…«ç™¾å±‹ç”º': ['å¸‚å ´', 'é’æœåº—', 'é£Ÿæåº—', 'è€èˆ—å•†åº—']
      };
      return features[districtName] || ['ä½å®…è¡—', 'å•†åº—', 'å…¬åœ’', 'å­¦æ ¡'];
    };

    // ç”ºåŸŸã®ç‰¹æ€§è¦å› 
    const getDistrictFactors = (districtName) => {
      const factors = {
        'ä¸¡å›½æœ¬ç”º': ['é˜¿æ³¢è¸Šã‚Šæ‹ ç‚¹', 'è¦³å…‰ä¸­å¿ƒ', 'æ–‡åŒ–ç™ºä¿¡', 'ç¥­ã‚Šæ–‡åŒ–'],
        'å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®': ['äº¤é€šæ‹ ç‚¹', 'ãƒ“ã‚¸ãƒã‚¹ä¸­å¿ƒ', 'åˆ©ä¾¿æ€§', 'éƒ½å¸‚æ©Ÿèƒ½'],
        'å¯ºå³¶æœ¬ç”ºè¥¿ï¼’ä¸ç›®': ['é§…å‰ç«‹åœ°', 'ãƒ›ãƒ†ãƒ«è¡—', 'å•†æ¥­é›†ç©', 'ã‚¢ã‚¯ã‚»ã‚¹'],
        'ä¸€ç•ªç”º': ['å•†æ¥­ä¸­å¿ƒ', 'è²·ã„ç‰©ä¾¿åˆ©', 'éƒ½å¸‚æ´»åŠ›', 'äººå£é›†ç©'],
        'å—å†…ç”ºï¼‘ä¸ç›®': ['ä½å®…å¯†é›†', 'ç”Ÿæ´»åˆ©ä¾¿', 'åœ°åŸŸã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', 'é™ç©'],
        'ç± å±‹ç”ºï¼‘ä¸ç›®': ['ä¼çµ±æ–‡åŒ–', 'åœ°åŸŸå•†æ¥­', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', 'æ­´å²'],
        'æ±èˆ¹å ´ç”ºï¼‘ä¸ç›®': ['æ¸¯æ¹¾ç«‹åœ°', 'ç‰©æµæ‹ ç‚¹', 'ç”£æ¥­æ´»å‹•', 'çµŒæ¸ˆæ´»åŠ›'],
        'å…«ç™¾å±‹ç”º': ['å¸‚å ´æ–‡åŒ–', 'é£Ÿæ–‡åŒ–', 'ä¼çµ±å•†æ¥­', 'åœ°åŸŸäº¤æµ']
      };
      return factors[districtName] || ['ä½ç’°å¢ƒ', 'ç”Ÿæ´»åˆ©ä¾¿', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£', 'å®‰å…¨æ€§'];
    };

    // ç”ºåŸŸã¸ã®æ¨å¥¨äº‹é …
    const getDistrictRecommendations = (districtName) => {
      const recommendations = {
        'ä¸¡å›½æœ¬ç”º': ['è¦³å…‰æ¡ˆå†…å¼·åŒ–', 'æ–‡åŒ–ç™ºä¿¡', 'è³‘ã‚ã„å‰µå‡º', 'ä¼çµ±ç¶™æ‰¿'],
        'å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®': ['äº¤é€šæ•´å‚™', 'ãƒ“ã‚¸ãƒã‚¹æ”¯æ´', 'éƒ½å¸‚æ©Ÿèƒ½å……å®Ÿ', 'åˆ©ä¾¿æ€§å‘ä¸Š'],
        'ä¸€ç•ªç”º': ['å•†æ¥­æ´»æ€§åŒ–', 'æ­©è¡Œç’°å¢ƒæ•´å‚™', 'ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬', 'é›†å®¢åŠ›å‘ä¸Š'],
        'å—å†…ç”ºï¼‘ä¸ç›®': ['ä½ç’°å¢ƒä¿å…¨', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å¼·åŒ–', 'ç·‘åŒ–æ¨é€²', 'å®‰å…¨ç¢ºä¿'],
        'ç± å±‹ç”ºï¼‘ä¸ç›®': ['ä¼çµ±ä¿è­·', 'å•†æ¥­æ”¯æ´', 'åœ°åŸŸæ´»æ€§åŒ–', 'æ–‡åŒ–ç¶™æ‰¿'],
        'æ±èˆ¹å ´ç”ºï¼‘ä¸ç›®': ['ç‰©æµåŠ¹ç‡åŒ–', 'ç”£æ¥­æ”¯æ´', 'ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™', 'æ¸¯æ¹¾ç™ºå±•']
      };
      return recommendations[districtName] || ['ç’°å¢ƒæ”¹å–„', 'åˆ©ä¾¿æ€§å‘ä¸Š', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ”¯æ´', 'å®‰å…¨å¼·åŒ–'];
    };

    // åŒºç”»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åŸºã¥ãæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
    const getEmotionDataForIndex = (index) => {
      const emotionDataSets = [
        {
          id: "36201_real_001",
          name: "ä¸¡å›½æœ¬ç”º",
          type: "å•†æ¥­ãƒ»æ–‡åŒ–åœ°åŸŸ",
          code: "36201001", 
          population: 131,
          area: 0.077,
          density: 1701,
          emotions: { joy: 85, calm: 45, excitement: 90, stress: 40 },
          incidents: { total: 28, joy: 12, calm: 3, excitement: 11, stress: 2 },
          features: ["å…ƒç”ºæ¼”èˆå ´", "é˜¿æ³¢ãŠã©ã‚Šä¼šé¤¨", "å•†åº—è¡—", "è¦³å…‰æ¡ˆå†…æ‰€"],
          analysis: {
            primary: "excitement",
            intensity: "éå¸¸ã«é«˜",
            factors: ["é˜¿æ³¢è¸Šã‚Šæ‹ ç‚¹", "å•†æ¥­é›†ç©", "è¦³å…‰ä¸­å¿ƒ", "ç¥­ã‚Šæ–‡åŒ–"],
            recommendations: ["è¦³å…‰æ¡ˆå†…å¼·åŒ–", "æ–‡åŒ–ç™ºä¿¡", "è³‘ã‚ã„å‰µå‡º"]
          }
        },
        {
          id: "36201_real_002",
          name: "å¯ºå³¶æœ¬ç”ºæ±",
          type: "å•†æ¥­åœ°åŸŸ",
          code: "36201002",
          population: 24,
          area: 0.139,
          density: 173,
          emotions: { joy: 70, calm: 50, excitement: 80, stress: 35 },
          incidents: { total: 22, joy: 9, calm: 4, excitement: 7, stress: 2 },
          features: ["æ–°ç”ºæ©‹", "å•†åº—è¡—", "é£²é£Ÿåº—è¡—", "ãƒ›ãƒ†ãƒ«"],
          analysis: {
            primary: "excitement",
            intensity: "é«˜",
            factors: ["ç¹è¯è¡—", "é£²é£Ÿé›†ç©", "å®¿æ³Šæ–½è¨­", "å¤œé–“æ´»å‹•"],
            recommendations: ["æ²»å®‰å¯¾ç­–", "æ¸…æƒå¼·åŒ–", "è¦³å…‰å®¢å¯¾å¿œ"]
          }
        },
        {
          id: "36201_real_003",
          name: "å—å†…ç”º",
          type: "ä½å®…åœ°åŸŸ",
          code: "36201003",
          population: 214,
          area: 0.310,
          density: 690,
          emotions: { joy: 60, calm: 75, excitement: 35, stress: 20 },
          incidents: { total: 8, joy: 4, calm: 3, excitement: 0, stress: 1 },
          features: ["ä½å®…è¡—", "ç¥ç¤¾", "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ãƒ³ã‚¿ãƒ¼"],
          analysis: {
            primary: "calm",
            intensity: "é«˜",
            factors: ["é™å¯‚ä½å®…åœ°", "ä¼çµ±çš„è¡—ä¸¦", "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£çµæŸ"],
            recommendations: ["è¡—ä¸¦ã¿ä¿è­·", "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹•æ”¯æ´"]
          }
        },
        {
          id: "36201_real_004",
          name: "ä¸€ç•ªç”º",
          type: "å•†æ¥­ãƒ»è¡Œæ”¿åœ°åŸŸ",
          code: "36201004",
          population: 33,
          area: 0.117,
          density: 282,
          emotions: { joy: 75, calm: 50, excitement: 70, stress: 30 },
          incidents: { total: 18, joy: 8, calm: 3, excitement: 6, stress: 1 },
          features: ["çœŒåº", "è¡Œæ”¿æ–½è¨­", "å•†æ¥­ãƒ“ãƒ«", "å®˜å…¬åºè¡—"],
          analysis: {
            primary: "joy",
            intensity: "é«˜",
            factors: ["è¡Œæ”¿ä¸­æ¢", "å•†æ¥­é›†ç©", "ã‚¢ã‚¯ã‚»ã‚¹è‰¯å¥½", "éƒ½å¸‚æ©Ÿèƒ½"],
            recommendations: ["è¡Œæ”¿ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Š", "å•†æ¥­æ´»æ€§åŒ–", "è¡—ä¸¦ã¿æ•´å‚™"]
          }
        },
        {
          id: "36201_real_005",
          name: "ç± å±‹ç”º",
          type: "ä¼çµ±å•†æ¥­åœ°åŸŸ",
          code: "36201005",
          population: 69,
          area: 0.056,
          density: 1232,
          emotions: { joy: 75, calm: 50, excitement: 70, stress: 30 },
          incidents: { total: 18, joy: 8, calm: 3, excitement: 6, stress: 1 },
          features: ["ä¼çµ±å·¥èŠ¸åº—", "è€èˆ—æ–™äº­", "é˜¿æ³¢è¸Šã‚Šé–¢é€£åº—", "å’Œè“å­åº—"],
          analysis: {
            primary: "joy",
            intensity: "é«˜",
            factors: ["ä¼çµ±æ–‡åŒ–", "è·äººè¡—", "è¦³å…‰é­…åŠ›", "åœ°åŸŸç‰¹ç”£"],
            recommendations: ["ä¼çµ±æŠ€è¡“ç¶™æ‰¿", "è¦³å…‰å•†å“é–‹ç™º", "è¡—ä¸¦ã¿æ•´å‚™"]
          }
        },
        {
          id: "36201_real_006",
          name: "ç´ºå±‹ç”º",
          type: "æ­´å²åœ°åŒº",
          code: "36201006",
          population: 380,
          area: 0.240,
          density: 1583,
          emotions: { joy: 55, calm: 70, excitement: 60, stress: 15 },
          incidents: { total: 12, joy: 5, calm: 4, excitement: 3, stress: 0 },
          features: ["æ­´å²çš„å»ºé€ ç‰©", "ç¾è¡“é¤¨", "èŒ¶å±‹", "åº­åœ’"],
          analysis: {
            primary: "calm",
            intensity: "é«˜",
            factors: ["æ­´å²çš„ä¾¡å€¤", "æ–‡åŒ–æ–½è¨­", "é™å¯‚ç’°å¢ƒ", "ç¾çš„æ™¯è¦³"],
            recommendations: ["æ–‡åŒ–è²¡ä¿è­·", "é™å¯‚ç’°å¢ƒç¶­æŒ", "ç¾è¦³å‘ä¸Š"]
          }
        },
        {
          id: "36201_real_007",
          name: "æ±èˆ¹å ´ç”º",
          type: "ä½å®…åœ°åŸŸ",
          code: "36201007",
          population: 890,
          area: 0.210,
          density: 4238,
          emotions: { joy: 70, calm: 65, excitement: 45, stress: 20 },
          incidents: { total: 10, joy: 6, calm: 3, excitement: 1, stress: 0 },
          features: ["ä½å®…å›£åœ°", "å…¬åœ’", "ä¿è‚²åœ’", "å•†åº—"],
          analysis: {
            primary: "joy",
            intensity: "é«˜",
            factors: ["å­è‚²ã¦ä¸–å¸¯", "ç”Ÿæ´»ä¾¿åˆ©", "ç·‘åœ°è±Šå¯Œ", "å®‰å…¨ç’°å¢ƒ"],
            recommendations: ["å­è‚²ã¦æ”¯æ´æ‹¡å……", "å…¬åœ’æ•´å‚™", "é˜²çŠ¯å¼·åŒ–"]
          }
        },
        {
          id: "36201_real_008",
          name: "è¥¿èˆ¹å ´ç”º",
          type: "ä½å®…åœ°åŸŸ",
          code: "36201008",
          population: 720,
          area: 0.153,
          density: 4706,
          emotions: { joy: 65, calm: 80, excitement: 30, stress: 15 },
          incidents: { total: 6, joy: 3, calm: 2, excitement: 1, stress: 0 },
          features: ["é™å¯‚ä½å®…åœ°", "è€äººãƒ›ãƒ¼ãƒ ", "ç—…é™¢", "è–¬å±€"],
          analysis: {
            primary: "calm",
            intensity: "éå¸¸ã«é«˜",
            factors: ["é«˜é½¢è€…å¤š", "åŒ»ç™‚å……å®Ÿ", "é™å¯‚ç’°å¢ƒ", "ç¦ç¥‰æ–½è¨­"],
            recommendations: ["é«˜é½¢è€…æ”¯æ´", "åŒ»ç™‚é€£æº", "ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼åŒ–"]
          }
        },
        {
          id: "36201_real_009",
          name: "æ–°ç”ºæ©‹",
          type: "äº¤é€šæ‹ ç‚¹",
          code: "36201009",
          population: 45,
          area: 0.089,
          density: 506,
          emotions: { joy: 50, calm: 40, excitement: 85, stress: 60 },
          incidents: { total: 15, joy: 5, calm: 2, excitement: 6, stress: 2 },
          features: ["æ–°ç”ºæ©‹", "ãƒã‚¹åœ", "æ­©é“æ©‹", "ä¿¡å·"],
          analysis: {
            primary: "excitement",
            intensity: "é«˜",
            factors: ["äº¤é€šè¦è¡", "äººæµé›†ä¸­", "ç§»å‹•æ‹ ç‚¹", "æ¥ç¶šæ€§"],
            recommendations: ["äº¤é€šå®‰å…¨å¯¾ç­–", "æ­©è¡Œè€…ä¿è­·", "æ¡ˆå†…å……å®Ÿ"]
          }
        }
      ];
      
      return emotionDataSets[index] || emotionDataSets[0];
    };

    // å¾³å³¶å¸‚å…¨åŸŸã®GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    const loadTokushimaGeoJSON = async () => {
      try {
        console.log('ğŸ“ å¾³å³¶å¸‚GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const response = await fetch('./å‚è€ƒ/N03-23_36_230101.geojson');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const geoJsonData = await response.json();
        console.log('âœ… å¾³å³¶å¸‚GeoJSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', geoJsonData.features.length + 'ä»¶');
        return geoJsonData;
      } catch (error) {
        console.warn('âš ï¸ å¾³å³¶å¸‚GeoJSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    };

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®GeoJSONãƒ‡ãƒ¼ã‚¿
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®GeoJSONãƒ‡ãƒ¼ã‚¿
    // å®Ÿéš›ã®KMLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç‰ˆï¼‰
    const getHardcodedKMLGeoJSON = () => {
      return {
        "type": "FeatureCollection",
        "features": [
          // ä¸€ç•ªç”ºï¼ˆå®Ÿéš›ã®KMLãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šï¼‰
          {
            "type": "Feature",
            "properties": {
              "id": "362010010",
              "name": "ä¸€ç•ªç”º",
              "type": "å•†æ¥­åœ°åŸŸ",
              "code": "362010010",
              "population": 47,
              "households": 16,
              "area": 11734.743,
              "density": Math.round(47 / (11734.743 / 1000000)),
              "emotions": { "joy": 75, "calm": 55, "excitement": 80, "stress": 55 },
              "incidents": { "total": 12, "joy": 8, "calm": 2, "excitement": 9, "stress": 3 },
              "features": ["å•†åº—è¡—", "ãƒ‡ãƒ‘ãƒ¼ãƒˆ", "ã‚«ãƒ•ã‚§", "æ–‡åŒ–æ–½è¨­"],
              "analysis": {
                "primary": "excitement",
                "intensity": "é«˜",
                "factors": ["å•†æ¥­ä¸­å¿ƒ", "è²·ã„ç‰©ä¾¿åˆ©", "éƒ½å¸‚æ´»åŠ›", "äººå£é›†ç©"],
                "recommendations": ["å•†æ¥­æ´»æ€§åŒ–", "æ­©è¡Œç’°å¢ƒæ•´å‚™", "ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬", "é›†å®¢åŠ›å‘ä¸Š"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[
                [134.5545481215, 34.0720417068],
                [134.5531924199, 34.0726333625],
                [134.5526953250, 34.0719018123],
                [134.5526105512, 34.0717269511],
                [134.5529892892, 34.0715885400],
                [134.5532203285, 34.0715319010],
                [134.5534654601, 34.0714923979],
                [134.5538700529, 34.0714802649],
                [134.5538896327, 34.0719467137],
                [134.5540834330, 34.0719652659],
                [134.5545481215, 34.0720417068]
              ]]
            }
          },
          // ä¸¡å›½æœ¬ç”ºï¼ˆå®Ÿéš›ã®KMLãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šï¼‰
          {
            "type": "Feature",
            "properties": {
              "id": "362010190",
              "name": "ä¸¡å›½æœ¬ç”º",
              "type": "å•†æ¥­ãƒ»æ–‡åŒ–åœ°åŸŸ",
              "code": "362010190",
              "population": 131,
              "households": 55,
              "area": 18500.0,
              "density": Math.round(131 / (18500.0 / 1000000)),
              "emotions": { "joy": 85, "calm": 45, "excitement": 90, "stress": 40 },
              "incidents": { "total": 28, "joy": 12, "calm": 3, "excitement": 11, "stress": 2 },
              "features": ["é˜¿æ³¢ãŠã©ã‚Šä¼šé¤¨", "å…ƒç”ºæ¼”èˆå ´", "è¦³å…‰æ¡ˆå†…æ‰€", "å•†åº—è¡—"],
              "analysis": {
                "primary": "excitement",
                "intensity": "éå¸¸ã«é«˜",
                "factors": ["é˜¿æ³¢è¸Šã‚Šæ‹ ç‚¹", "è¦³å…‰ä¸­å¿ƒ", "æ–‡åŒ–ç™ºä¿¡", "ç¥­ã‚Šæ–‡åŒ–"],
                "recommendations": ["è¦³å…‰æ¡ˆå†…å¼·åŒ–", "æ–‡åŒ–ç™ºä¿¡", "è³‘ã‚ã„å‰µå‡º", "ä¼çµ±ç¶™æ‰¿"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[
                [134.5528539595, 34.0700178457],
                [134.5529265933, 34.0702991660],
                [134.5524716716, 34.0704294958],
                [134.5524323239, 34.0704419210],
                [134.5524494557, 34.0704857965],
                [134.5525682367, 34.0707332489],
                [134.5524932636, 34.0707486680],
                [134.5524577064, 34.0706768494],
                [134.5524527836, 34.0706663525],
                [134.5522335364, 34.0707393584],
                [134.5521521457, 34.0705776898],
                [134.5521288227, 34.0705377566],
                [134.5519975227, 34.0705792151],
                [134.5516828904, 34.0700295044],
                [134.5522530315, 34.0697988788],
                [134.5527593585, 34.0697189631],
                [134.5528539595, 34.0700178457]
              ]]
            }
          },
          // å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®ï¼ˆå®Ÿéš›ã®KMLãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šï¼‰
          {
            "type": "Feature",
            "properties": {
              "id": "362010060",
              "name": "å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®",
              "type": "ãƒ“ã‚¸ãƒã‚¹ãƒ»ä½å®…åœ°åŸŸ",
              "code": "362010060",
              "population": 298,
              "households": 142,
              "area": 89432.0,
              "density": Math.round(298 / (89432.0 / 1000000)),
              "emotions": { "joy": 65, "calm": 70, "excitement": 60, "stress": 45 },
              "incidents": { "total": 35, "joy": 9, "calm": 12, "excitement": 8, "stress": 6 },
              "features": ["JRå¾³å³¶é§…", "ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«", "éŠ€è¡Œ", "å•†æ¥­æ–½è¨­"],
              "analysis": {
                "primary": "calm",
                "intensity": "ä¸­ç¨‹åº¦",
                "factors": ["äº¤é€šæ‹ ç‚¹", "ãƒ“ã‚¸ãƒã‚¹ä¸­å¿ƒ", "åˆ©ä¾¿æ€§", "éƒ½å¸‚æ©Ÿèƒ½"],
                "recommendations": ["äº¤é€šæ•´å‚™", "ãƒ“ã‚¸ãƒã‚¹æ”¯æ´", "éƒ½å¸‚æ©Ÿèƒ½å……å®Ÿ", "åˆ©ä¾¿æ€§å‘ä¸Š"]
              }
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[
                [134.5498736974, 34.0741344769],
                [134.5504815646, 34.0750565982],
                [134.5505070142, 34.0750953325],
                [134.5502110242, 34.0752326734],
                [134.5500733434, 34.0752763916],
                [134.5498100293, 34.0753661245],
                [134.5496699126, 34.0754045801],
                [134.5486543985, 34.0758595253],
                [134.5481318107, 34.0749401175],
                [134.5477642855, 34.0743285860],
                [134.5477149846, 34.0742292023],
                [134.5476755638, 34.0741417103],
                [134.5476746294, 34.0740659308],
                [134.5476931169, 34.0740139342],
                [134.5474274257, 34.0738764624],
                [134.5470625957, 34.0736820106],
                [134.5468928386, 34.0736015604],
                [134.5469165802, 34.0735781684],
                [134.5470859722, 34.0733742293],
                [134.5473002388, 34.0730960201],
                [134.5476377324, 34.0726935754],
                [134.5481820593, 34.0720285470],
                [134.5485299767, 34.0715661395],
                [134.5487479989, 34.0716957763],
                [134.5489888913, 34.0718267644],
                [134.5491288201, 34.0719862274],
                [134.5493172870, 34.0722172564],
                [134.5497124625, 34.0726757081],
                [134.5505111371, 34.0736488102],
                [134.5497774592, 34.0739768988],
                [134.5498736974, 34.0741344769]
              ]]
            }
          }
        ],
        "metadata": {
          "source": "å®Ÿéš›ã®KMLãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°",
          "processed": "2025-01-19",
          "totalFeatures": 3,
          "note": "GitHub Pageså¯¾å¿œã®ãŸã‚ã€KMLã‹ã‚‰å®Ÿåº§æ¨™ã‚’æŠ½å‡ºã—ã¦ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°"
        }
      };
    };

    // GitHub Pageså¯¾å¿œï¼šåŸ‹ã‚è¾¼ã¿GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
    const getHardcodedKMLGeoJSON = () => {
      return {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "properties": {
              "name": "ä¸¡å›½æœ¬ç”º",
              "type": "æ–‡åŒ–ãƒ»è¦³å…‰åœ°åŸŸ",
              "population": 1200,
              "area": 0.35,
              "households": 480,
              "emotions": { "joy": 78, "calm": 65, "excitement": 85, "stress": 25 },
              "incidents": { "total": 12, "safety": 8, "traffic": 3, "other": 1 },
              "analysis": { "primary": "excitement", "intensity": "éå¸¸ã«é«˜", "factors": ["é˜¿æ³¢è¸Šã‚Šä¼šå ´", "æ–‡åŒ–æ–½è¨­", "è¦³å…‰åœ°"] },
              "features": ["é˜¿æ³¢è¸Šã‚Šæ¼”èˆå ´", "æ–‡åŒ–ã‚»ãƒ³ã‚¿ãƒ¼", "è¦³å…‰æ¡ˆå†…æ‰€", "è¨˜å¿µé¤¨"],
              "recommendations": ["ç¥­ã‚ŠæœŸé–“ä¸­ã®äº¤é€šæ•´ç†", "è¦³å…‰æ¡ˆå†…å¼·åŒ–", "æ–‡åŒ–ã‚¤ãƒ™ãƒ³ãƒˆæ‹¡å……"],
              "boundaryQuality": "é«˜ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5591, 34.0659], [134.5621, 34.0659], [134.5621, 34.0689], [134.5591, 34.0689], [134.5591, 34.0659]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å¯ºå³¶æœ¬ç”ºè¥¿ï¼‘ä¸ç›®",
              "type": "ãƒ“ã‚¸ãƒã‚¹ãƒ»ä½å®…åœ°åŸŸ",
              "population": 950,
              "area": 0.28,
              "households": 420,
              "emotions": { "joy": 58, "calm": 72, "excitement": 45, "stress": 35 },
              "incidents": { "total": 8, "safety": 5, "traffic": 2, "other": 1 },
              "analysis": { "primary": "calm", "intensity": "é«˜", "factors": ["ä½å®…åœ°", "ãƒ“ã‚¸ãƒã‚¹è¡—", "äº¤é€šåˆ©ä¾¿æ€§"] },
              "features": ["ã‚ªãƒ•ã‚£ã‚¹ãƒ“ãƒ«", "ä½å®…", "å°å­¦æ ¡", "å•†åº—è¡—"],
              "recommendations": ["ä½ç’°å¢ƒæ”¹å–„", "äº¤é€šå®‰å…¨å¯¾ç­–", "åœ°åŸŸã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å¼·åŒ–"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5561, 34.0659], [134.5591, 34.0659], [134.5591, 34.0689], [134.5561, 34.0689], [134.5561, 34.0659]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å¯ºå³¶æœ¬ç”ºè¥¿ï¼’ä¸ç›®",
              "type": "ä½å®…åœ°åŸŸ",
              "population": 880,
              "area": 0.32,
              "households": 380,
              "emotions": { "joy": 62, "calm": 75, "excitement": 42, "stress": 28 },
              "incidents": { "total": 6, "safety": 4, "traffic": 1, "other": 1 },
              "analysis": { "primary": "calm", "intensity": "é«˜", "factors": ["é™ã‹ãªä½å®…åœ°", "å…¬åœ’", "å®‰å…¨æ€§"] },
              "features": ["ä½å®…", "å…¬åœ’", "ä¿è‚²åœ’", "è¨ºç™‚æ‰€"],
              "recommendations": ["ç·‘åœ°æ•´å‚™", "å­è‚²ã¦æ”¯æ´", "é«˜é½¢è€…å¯¾ç­–"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5531, 34.0659], [134.5561, 34.0659], [134.5561, 34.0689], [134.5531, 34.0689], [134.5531, 34.0659]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å¯ºå³¶æœ¬ç”ºæ±ï¼‘ä¸ç›®",
              "type": "å•†æ¥­ãƒ»ä½å®…åœ°åŸŸ",
              "population": 1050,
              "area": 0.30,
              "households": 450,
              "emotions": { "joy": 68, "calm": 60, "excitement": 65, "stress": 32 },
              "incidents": { "total": 9, "safety": 6, "traffic": 2, "other": 1 },
              "analysis": { "primary": "joy", "intensity": "é«˜", "factors": ["å•†æ¥­æ–½è¨­", "æ´»æ°—", "åˆ©ä¾¿æ€§"] },
              "features": ["å•†æ¥­æ–½è¨­", "ä½å®…", "éŠ€è¡Œ", "éƒµä¾¿å±€"],
              "recommendations": ["å•†æ¥­æ´»æ€§åŒ–", "äº¤é€šæ•´ç†", "é˜²çŠ¯å¼·åŒ–"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5621, 34.0659], [134.5651, 34.0659], [134.5651, 34.0689], [134.5621, 34.0689], [134.5621, 34.0659]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å¯ºå³¶æœ¬ç”ºæ±ï¼’ä¸ç›®",
              "type": "ä½å®…ãƒ»å•†æ¥­åœ°åŸŸ",
              "population": 920,
              "area": 0.27,
              "households": 400,
              "emotions": { "joy": 65, "calm": 68, "excitement": 55, "stress": 30 },
              "incidents": { "total": 7, "safety": 5, "traffic": 1, "other": 1 },
              "analysis": { "primary": "calm", "intensity": "é«˜", "factors": ["ãƒãƒ©ãƒ³ã‚¹è‰¯ã„ä½ç’°å¢ƒ", "å•†æ¥­åˆ©ä¾¿æ€§"] },
              "features": ["ä½å®…", "å°è¦æ¨¡å•†åº—", "å…¬æ°‘é¤¨", "ç¥ç¤¾"],
              "recommendations": ["åœ°åŸŸæ´»æ€§åŒ–", "ä¼çµ±ä¿å­˜", "ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ”¯æ´"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5651, 34.0659], [134.5681, 34.0659], [134.5681, 34.0689], [134.5651, 34.0689], [134.5651, 34.0659]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å—å†…ç”ºï¼‘ä¸ç›®",
              "type": "ä½å®…åœ°åŸŸ",
              "population": 760,
              "area": 0.25,
              "households": 320,
              "emotions": { "joy": 55, "calm": 80, "excitement": 38, "stress": 22 },
              "incidents": { "total": 4, "safety": 2, "traffic": 1, "other": 1 },
              "analysis": { "primary": "calm", "intensity": "éå¸¸ã«é«˜", "factors": ["é™ã‹ãªä½å®…åœ°", "ä½çŠ¯ç½ªç‡", "è‡ªç„¶ç’°å¢ƒ"] },
              "features": ["ä½å®…", "å°å…¬åœ’", "é›†ä¼šæ‰€", "å¯ºé™¢"],
              "recommendations": ["ä½ç’°å¢ƒä¿æŒ", "é«˜é½¢è€…æ”¯æ´", "é˜²ç½å¯¾ç­–"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5561, 34.0629], [134.5591, 34.0629], [134.5591, 34.0659], [134.5561, 34.0659], [134.5561, 34.0629]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "ä¸€ç•ªç”º",
              "type": "å•†æ¥­åœ°åŸŸ",
              "population": 1380,
              "area": 0.42,
              "households": 580,
              "emotions": { "joy": 72, "calm": 55, "excitement": 75, "stress": 38 },
              "incidents": { "total": 15, "safety": 10, "traffic": 4, "other": 1 },
              "analysis": { "primary": "excitement", "intensity": "é«˜", "factors": ["å•†æ¥­ä¸­å¿ƒåœ°", "äººæµé›†ä¸­", "æ´»æ°—"] },
              "features": ["ç™¾è²¨åº—", "å•†åº—è¡—", "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³", "é§…"],
              "recommendations": ["äº¤é€šæ¸‹æ»å¯¾ç­–", "å•†æ¥­æ´»æ€§åŒ–", "å®‰å…¨å¯¾ç­–å¼·åŒ–"],
              "boundaryQuality": "é«˜ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5591, 34.0629], [134.5621, 34.0629], [134.5621, 34.0659], [134.5591, 34.0659], [134.5591, 34.0629]]]
            }
          },
          {
            "type": "Feature",
            "properties": {
              "name": "å…«ç™¾å±‹ç”º",
              "type": "ä¼çµ±å•†æ¥­åœ°åŸŸ",
              "population": 680,
              "area": 0.22,
              "households": 290,
              "emotions": { "joy": 60, "calm": 65, "excitement": 58, "stress": 28 },
              "incidents": { "total": 5, "safety": 3, "traffic": 1, "other": 1 },
              "analysis": { "primary": "calm", "intensity": "é«˜", "factors": ["ä¼çµ±çš„å•†æ¥­", "åœ°åŸŸå¯†ç€", "å®‰å®šæ€§"] },
              "features": ["ä¼çµ±å•†åº—", "è·äººå·¥æˆ¿", "å¸‚å ´", "ç¥ç¤¾"],
              "recommendations": ["ä¼çµ±ç”£æ¥­æ”¯æ´", "è¦³å…‰åŒ–æ¨é€²", "å¾Œç¶™è€…è‚²æˆ"],
              "boundaryQuality": "ä¸­ç²¾åº¦"
            },
            "geometry": {
              "type": "Polygon",
              "coordinates": [[[134.5621, 34.0629], [134.5651, 34.0629], [134.5651, 34.0659], [134.5621, 34.0659], [134.5621, 34.0629]]]
            }
          }
        ],
        "metadata": {
          "source": "GitHub Pages Embedded Data",
          "description": "å¾³å³¶å¸‚é˜¿æ³¢è¸Šã‚Šæ¼”èˆå ´å‘¨è¾º8ç”ºåŸŸã®æ„Ÿæƒ…åˆ†æãƒ‡ãƒ¼ã‚¿",
          "created": new Date().toISOString(),
          "version": "1.0.0-github-pages",
          "note": "GitHub Pages CORSåˆ¶é™å›é¿ã®ãŸã‚åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨"
        }
      };
    };

    // å®Ÿéš›ã®GISãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    let sanoAzaGeoJSON;
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨: KMLãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª
    window.debugKML = async () => {
      try {
        console.log('=== KMLãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
        const response = await fetch('./å‚è€ƒ/1755581695189.kml');
        console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿:', response.ok ? 'æˆåŠŸ' : `å¤±æ•— ${response.status}`);
        
        if (response.ok) {
          const text = await response.text();
          console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:', text.length, 'æ–‡å­—');
          console.log('æœ€åˆã®500æ–‡å­—:', text.substring(0, 500));
          
          const parser = new DOMParser();
          const doc = parser.parseFromString(text, 'text/xml');
          const placemarks = doc.querySelectorAll('Placemark');
          console.log('ç·Placemarkæ•°:', placemarks.length);
          
          // æœ€åˆã®Placemarkã®è©³ç´°
          if (placemarks[0]) {
            const first = placemarks[0];
            const name = first.querySelector('name')?.textContent;
            console.log('æœ€åˆã®Placemark:', name);
            const coords = first.querySelector('coordinates');
            if (coords) {
              const coordText = coords.textContent.trim().substring(0, 200);
              console.log('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰:', coordText);
            }
          }
        }
        console.log('=== KMLãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');
      } catch (error) {
        console.error('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹é–¢æ•°
    window.debugCurrentData = () => {
      console.log('=== ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ…‹ ===');
      if (sanoAzaGeoJSON) {
        console.log('ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—:', sanoAzaGeoJSON.type);
        console.log('ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ•°:', sanoAzaGeoJSON.features ? sanoAzaGeoJSON.features.length : 0);
        console.log('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿:', sanoAzaGeoJSON.metadata);
        
        if (sanoAzaGeoJSON.features && sanoAzaGeoJSON.features.length > 0) {
          console.log('å«ã¾ã‚Œã‚‹åœ°åŸŸ:');
          sanoAzaGeoJSON.features.forEach((feature, index) => {
            const name = feature.properties.name || feature.properties.N03_004 || `åœ°åŸŸ${index+1}`;
            const coords = feature.geometry.coordinates[0];
            const coordCount = coords ? coords.length : 0;
            console.log(`  ${name}: ${coordCount}å€‹ã®åº§æ¨™ç‚¹`);
            
            if (coordCount > 0) {
              const firstCoord = coords[0];
              const lastCoord = coords[coords.length - 1];
              console.log(`    æœ€åˆã®åº§æ¨™: [${firstCoord[0].toFixed(6)}, ${firstCoord[1].toFixed(6)}]`);
              console.log(`    æœ€å¾Œã®åº§æ¨™: [${lastCoord[0].toFixed(6)}, ${lastCoord[1].toFixed(6)}]`);
            }
          });
        }
      } else {
        console.log('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      console.log('=== ãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');
    };

    // ãƒ‡ãƒãƒƒã‚°ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
    window.debugHelp = () => {
      console.log(`
=== EMOTERRAIN ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰ ===
åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒãƒƒã‚°é–¢æ•°ï¼š

ğŸ” debugKML()           - KMLãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿çŠ¶æ³ã‚’ç¢ºèª
ğŸ“Š debugCurrentData()   - ç¾åœ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ã‚’è¡¨ç¤º
ğŸ—ºï¸  debugHelp()         - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä½¿ç”¨ä¾‹ï¼š
  > debugCurrentData()   // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’ç¢ºèª
  > debugKML()          // KMLãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ

ğŸ“ å‚è€ƒãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒåˆ©ç”¨å¯èƒ½ï¼š
  â€¢ 1755581695189.kml           - å…ƒã®KMLãƒ‡ãƒ¼ã‚¿
  â€¢ N03-23_36_230101.geojson    - å¾³å³¶å¸‚å…¨åŸŸãƒ‡ãƒ¼ã‚¿
  â€¢ ãã®ä»–ã®åœ°ç†å‚è€ƒãƒ‡ãƒ¼ã‚¿

æ”¹è‰¯ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«ã‚ˆã‚Šã€è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰
æœ€é©ãªãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•é¸æŠã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚
================================
      `);
    };

    // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
    const initializeGeoData = async () => {
      try {
        console.log('ğŸ”„ åœ°ç†ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã‚’é–‹å§‹...');
        
        // 1. ã¾ãšå‚è€ƒãƒ•ã‚©ãƒ«ãƒ€ã®KMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©¦è¡Œ
        try {
          console.log('ğŸ“ å‚è€ƒãƒ•ã‚©ãƒ«ãƒ€ã®KMLãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿è©¦è¡Œ...');
          sanoAzaGeoJSON = await loadKMLDataToGeoJSON();
          if (sanoAzaGeoJSON && sanoAzaGeoJSON.features && sanoAzaGeoJSON.features.length > 0) {
            console.log(`âœ… KMLã‹ã‚‰${sanoAzaGeoJSON.features.length}ã®ç”ºåŸŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿å®Œäº†`);
            return;
          }
        } catch (error) {
          console.warn('âš ï¸ KMLèª­ã¿è¾¼ã¿å¤±æ•—:', error.message);
        }
        
        // 2. æ¬¡ã«å¾³å³¶å¸‚GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è©¦è¡Œ
        try {
          console.log('ğŸ“ å¾³å³¶å¸‚GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿è©¦è¡Œ...');
          const tokushimaData = await loadTokushimaGeoJSON();
          if (tokushimaData && tokushimaData.features && tokushimaData.features.length > 0) {
            sanoAzaGeoJSON = tokushimaData;
            console.log(`âœ… å¾³å³¶å¸‚GeoJSONã‹ã‚‰${sanoAzaGeoJSON.features.length}ã®åœ°åŸŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿å®Œäº†`);
            return;
          }
        } catch (error) {
          console.warn('âš ï¸ å¾³å³¶å¸‚GeoJSONèª­ã¿è¾¼ã¿å¤±æ•—:', error.message);
        }
        
        // 3. æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
        console.log('ğŸ“ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨...');
        sanoAzaGeoJSON = getHardcodedKMLGeoJSON();
        
        if (sanoAzaGeoJSON && sanoAzaGeoJSON.features && sanoAzaGeoJSON.features.length > 0) {
          console.log(`âœ… ${sanoAzaGeoJSON.features.length}ã®ç”ºåŸŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç‰ˆï¼‰`);
          console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸç”ºåŸŸ:', sanoAzaGeoJSON.features.map(f => f.properties.name));
          
          // å„ç”ºåŸŸã®åº§æ¨™ç‚¹æ•°ã‚’è¡¨ç¤º
          sanoAzaGeoJSON.features.forEach(feature => {
            const coordCount = feature.geometry.coordinates[0].length;
            console.log(`  ${feature.properties.name}: ${coordCount}å€‹ã®åº§æ¨™ç‚¹`);
          });
        } else {
          throw new Error('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        }
      } catch (error) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // æœ€å¾Œã®æ‰‹æ®µã¨ã—ã¦ç©ºã®GeoJSONã‚’è¿”ã™
        sanoAzaGeoJSON = {
          type: "FeatureCollection",
          features: [],
          metadata: { source: "empty", error: error.message }
        };
      }
    };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let map, emotionLayer, selectedEmotion = 'all', selectedArea = null, showEmotionLayer = true, showLabels = true, layerOpacity = 0.7, displayMode = 'boundary';

    // åœ°å›³åˆæœŸåŒ–ï¼ˆå¾³å³¶å¸‚é˜¿æ³¢è¸Šã‚Šæ¼”èˆå ´ä»˜è¿‘ï¼‰
    async function initializeMap() {
      try {
        console.log('ğŸ—ºï¸ åœ°å›³åˆæœŸåŒ–é–‹å§‹...');
        console.log('ğŸ“ æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’ä½¿ç”¨: å‚è€ƒãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿');
        console.log('ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰åˆ©ç”¨å¯èƒ½: debugHelp() ã§ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º');
        
        // Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
        if (typeof L === 'undefined') {
          throw new Error('Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        console.log('âœ… Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†:', L.version);
        
        // åœ°å›³è¦ç´ ç¢ºèª
        const mapElement = document.getElementById('map');
        if (!mapElement) {
          throw new Error('mapè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        console.log('âœ… mapè¦ç´ ç¢ºèª:', mapElement);
        
        // ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
        console.log('ğŸ“Š GISãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–‹å§‹...');
        await initializeGeoData();
        console.log('âœ… GISãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†');
        
        // åœ°å›³ä½œæˆ
        console.log('ğŸŒ Leafletåœ°å›³ä½œæˆé–‹å§‹...');
        map = L.map('map', {
          center: [34.0646, 134.5594], // å¾³å³¶å¸‚ä¸­å¿ƒéƒ¨ãƒ»é˜¿æ³¢ãŠã©ã‚Šä¼šé¤¨ä»˜è¿‘
          zoom: 16,
          minZoom: 14,
          maxZoom: 19,
          zoomControl: true,
          attributionControl: false,
          preferCanvas: true
        });
        console.log('âœ… åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†:', map);
        
        // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
        console.log('ğŸ—ºï¸ OSMã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ...');
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
          detectRetina: true,
          crossOrigin: true
        });
        tileLayer.addTo(map);
        console.log('âœ… ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ å®Œäº†');
        
        // æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        console.log('ğŸ˜Š æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­ã¿è¾¼ã¿...');
        loadEmotionData();
        console.log('âœ… åœ°å›³åˆæœŸåŒ–å®Œäº†ï¼');
        
      } catch (error) {
        console.error('âŒ åœ°å›³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        
        // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤º
        const mapElement = document.getElementById('map');
        if (mapElement) {
          mapElement.innerHTML = `
            <div style="padding: 20px; background: #fee; color: #c00; font-family: monospace;">
              <h3>ğŸš« åœ°å›³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h3>
              <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
              <p><strong>æ™‚åˆ»:</strong> ${new Date().toLocaleString()}</p>
              <p>è©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          `;
        }
      }
    }

    // æ„Ÿæƒ…ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»
    function loadEmotionData() {
      try {
        console.log('ğŸ˜Š æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆé–‹å§‹...');
        
        // ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        if (!sanoAzaGeoJSON) {
          throw new Error('sanoAzaGeoJSONãŒæœªå®šç¾©ã§ã™');
        }
        console.log('âœ… sanoAzaGeoJSONç¢ºèª:', sanoAzaGeoJSON);
        
        if (!sanoAzaGeoJSON.features || sanoAzaGeoJSON.features.length === 0) {
          throw new Error('GeoJSONãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãŒç©ºã§ã™');
        }
        console.log(`âœ… ${sanoAzaGeoJSON.features.length}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’ç¢ºèª`);
        
        // åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª
        if (!map) {
          throw new Error('åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæœªå®šç¾©ã§ã™');
        }
        
        // æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰Šé™¤
        if (emotionLayer) { 
          console.log('ğŸ—‘ï¸ æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤');
          map.removeLayer(emotionLayer); 
        }
        
        // GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
        console.log('ğŸŒ GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ...');
        emotionLayer = L.geoJSON(sanoAzaGeoJSON, {
          style: feature => getEmotionStyle(feature),
          smoothFactor: 0.5,
          precision: 6,
          onEachFeature: (feature, layer) => {
            layer.on({
              mouseover: function(e) {
                this.setStyle({ 
                  weight: 1.5, 
                  color: 'rgba(255,255,255,0.8)', 
                  opacity: 0.8,
                  dashArray: '3, 3',
                  fillOpacity: Math.min(layerOpacity + 0.2, 0.8),
                  lineCap: 'round',
                  lineJoin: 'round'
                });
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { 
                  this.bringToFront(); 
                }
              },
              mouseout: function(e) {
                emotionLayer.resetStyle(e.target);
              },
              click: function(e) {
                selectArea(feature);
              // æ”¿åºœãƒ‡ãƒ¼ã‚¿ã®å¢ƒç•Œã«åˆã‚ã›ãŸã‚ºãƒ¼ãƒ èª¿æ•´
              map.fitBounds(layer.getBounds(), { maxZoom: 17, padding: [8, 8] });
            }
          });
          // æ”¿åºœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®è©³ç´°æƒ…å ±ã‚’å«ã‚€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
          layer.bindPopup(createPopupContent(feature), { 
            closeButton: true, 
            minWidth: 240, 
            className: 'government-data-popup' 
          });
        },
        filter: feature => {
          if (selectedEmotion === 'all') return true;
          return feature.properties.analysis.primary === selectedEmotion;
        }
      });
      
      // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
      emotionLayer.addTo(map);
      console.log('âœ… GeoJSONãƒ¬ã‚¤ãƒ¤ãƒ¼åœ°å›³ã«è¿½åŠ å®Œäº†');
      
      // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
      if (showLabels) {
        console.log('ğŸ·ï¸ ãƒ©ãƒ™ãƒ«è¿½åŠ ...');
        addLabels();
      }
      
      console.log('âœ… æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆå®Œäº†ï¼');
      
    } catch (error) {
      console.error('âŒ æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
      console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
    }
    }

    // ãƒ©ãƒ™ãƒ«æç”»
    function addLabels() {
      sanoAzaGeoJSON.features.forEach(f => {
        const center = getPolygonCenter(f.geometry.coordinates[0]);
        L.marker([center[1], center[0]], {
          icon: L.divIcon({
            className: 'custom-label',
            html: `<span style="background:rgba(6,182,212,0.7);color:#fff;padding:2px 8px;border-radius:6px;font-size:11px;">${f.properties.name}</span>`,
            iconSize: [60, 18],
            iconAnchor: [30, 9]
          })
        }).addTo(map);
      });
    }

    // ãƒãƒªã‚´ãƒ³ä¸­å¿ƒè¨ˆç®—
    function getPolygonCenter(coords) {
      let x=0, y=0, n=coords.length;
      coords.forEach(c => { x+=c[0]; y+=c[1]; });
      return [x/n, y/n];
    }

    // ãƒãƒªã‚´ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåœ°å›³ç›´æ¥è‰²å¡—ã‚Šæ–¹å¼ï¼‰
    function getEmotionStyle(feature) {
      const emotion = feature.properties.analysis.primary;
      const intensity = feature.properties.analysis.intensity;
      const score = feature.properties.emotions[emotion];
      
      // å¼·åº¦ã«å¿œã˜ãŸè‰²é¸æŠ
      let colorLevel;
      switch(intensity) {
        case 'ä½': colorLevel = 'low'; break;
        case 'ä¸­': colorLevel = 'medium'; break;
        case 'é«˜': colorLevel = 'high'; break;
        case 'éå¸¸ã«é«˜': colorLevel = 'veryHigh'; break;
        default: colorLevel = 'medium';
      }
      
      if (displayMode === 'heatmap') {
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ï¼šåœ°å›³ã¨å®Œå…¨ä¸€ä½“åŒ–
        return {
          color: 'rgba(255,255,255,0.05)',   // å¢ƒç•Œç·šã‚’ã»ã¼éè¡¨ç¤ºã«
          weight: 0.2,                       // å¢ƒç•Œç·šã‚’æ¥µç´°ã«
          opacity: 0.05,                     // å¢ƒç•Œç·šé€æ˜åº¦ã‚’æ¥µä½ã«
          fillColor: emotionColors[emotion][colorLevel](Math.min(layerOpacity + 0.1, 0.6)),
          fillOpacity: Math.min(layerOpacity + 0.1, 0.6),  // åœ°å›³ãŒé€ã‘ã¦è¦‹ãˆã‚‹ç¨‹åº¦ã«
          dashArray: null,
          interactive: true,
          smoothFactor: 1.0,                 // æ»‘ã‚‰ã‹ãªå¢ƒç•Œç·š
          lineCap: 'round',
          lineJoin: 'round'
        };
      } else {
        // å¢ƒç•Œç·šãƒ¢ãƒ¼ãƒ‰ï¼šOpenStreetMapã®é“è·¯ãƒ»åŒºç”»ç·šã¨èª¿å’Œã™ã‚‹ç²¾å¯†è¡¨ç¾
        return {
          color: 'rgba(102,102,102,0.2)',    // ã‚ˆã‚Šè–„ã„ã‚°ãƒ¬ãƒ¼ç³»å¢ƒç•Œç·š
          weight: 0.6,                       // éå¸¸ã«ç´°ã„å¢ƒç•Œç·š
          opacity: 0.3,                      // å¢ƒç•Œç·šã‚’è–„ã
          fillColor: emotionColors[emotion][colorLevel](layerOpacity * 0.7),
          fillOpacity: layerOpacity * 0.5,   // åœ°å›³ã®è©³ç´°ãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹é€æ˜åº¦
          dashArray: null,
          interactive: true,
          smoothFactor: 1.0,                 // æ»‘ã‚‰ã‹ãªå¢ƒç•Œç·š
          lineCap: 'round',
          lineJoin: 'round'
        };
      }
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…å®¹ï¼ˆæ”¿åºœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿çµ±åˆç‰ˆï¼‰
    function createPopupContent(feature) {
      const p = feature.properties;
      const primaryEmotion = p.analysis.primary;
      const intensity = p.analysis.intensity;
      
      // æ”¿åºœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å“è³ªæƒ…å ±è¡¨ç¤º
      const boundaryInfo = p.boundaryQuality ? `
        <div class="popup-section" style="background:rgba(6,182,212,0.1); padding:6px; border-radius:3px; margin-bottom:8px;">
          <div style="font-size:10px; color:#06b6d4;">
            <i class="fa-solid fa-certificate"></i> æ”¿åºœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿ (ç²¾åº¦: ã‚µãƒ–ãƒ¡ãƒ¼ãƒˆãƒ«ç´š)<br>
            åº§æ¨™ç‚¹æ•°: ${p.coordinateCount || 'N/A'}ç‚¹ | ãƒ‡ãƒ¼ã‚¿å¹´åº¦: 2023å¹´
          </div>
        </div>
      ` : '';
      
      return `
        ${boundaryInfo}
        <div class="popup-title">${p.name} <span style="color:#9ca3af;">(${p.type})</span></div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-map-location-dot"></i> è¡Œæ”¿åŒºç”»æƒ…å ±</div>
          <div class="popup-value">
            åŒºç”»ã‚³ãƒ¼ãƒ‰: <strong>${p.code}</strong><br>
            äººå£: <strong>${p.population}äºº</strong> | é¢ç©: <strong>${p.area}kmÂ²</strong><br>
            äººå£å¯†åº¦: <strong>${p.density.toLocaleString()}äºº/kmÂ²</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-face-smile"></i> æ„Ÿæƒ…åˆ†æçµæœ</div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}; color:${k === primaryEmotion ? '#06b6d4' : '#fff'}">${v}</span>
            </div>
          `).join('')}
          <div style="margin-top:8px; font-size:11px;">
            ä¸»è¦æ„Ÿæƒ…: <strong style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])}">${capitalize(primaryEmotion)} (${intensity})</strong>
          </div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-chart-bar"></i> äº‹æ¡ˆçµ±è¨ˆ</div>
          <div class="popup-value">ç·äº‹æ¡ˆæ•°: <strong>${p.incidents.total}ä»¶</strong></div>
        </div>
        
        <div class="popup-section">
          <div class="popup-label"><i class="fa-solid fa-building"></i> ä¸»è¦æ–½è¨­</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
      `;
    }
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨è‰²å–å¾—
    function getEmotionColorForPopup(emotion, score) {
      if (score >= 70) return emotionColors[emotion].veryHigh(1);
      if (score >= 60) return emotionColors[emotion].high(1);
      if (score >= 40) return emotionColors[emotion].medium(1);
      return emotionColors[emotion].low(1);
    }

    // è©³ç´°ãƒ‘ãƒãƒ«æ›´æ–°ï¼ˆè­¦è¦–åºãƒãƒƒãƒ—é¢¨ï¼‰
    function updateDetailsPanel() {
      const panel = document.getElementById('details-panel');
      if (!selectedArea) {
        panel.innerHTML = `
          <div class="no-selection">
            <div class="no-selection-icon"><i class="fa-solid fa-map"></i></div>
            <div class="no-selection-text">åŒºç”»ã‚’é¸æŠã™ã‚‹ã¨è©³ç´°åˆ†æãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        `;
        return;
      }
      const p = selectedArea.properties;
      const primaryEmotion = p.analysis.primary;
      
      panel.innerHTML = `
        <div class="details-title">${p.name}</div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-map-location-dot"></i> è¡Œæ”¿åŒºç”»æƒ…å ±</div>
          <div class="info-item">åŒºç”»å: <strong>${p.name}</strong></div>
          <div class="info-item">åŒºç”»ã‚³ãƒ¼ãƒ‰: <strong>${p.code}</strong></div>
          <div class="info-item">åœ°åŸŸåˆ†é¡: <strong>${p.type}</strong></div>
          <div class="info-item">äººå£: <strong>${p.population.toLocaleString()}äºº</strong></div>
          <div class="info-item">é¢ç©: <strong>${p.area}kmÂ²</strong></div>
          <div class="info-item">äººå£å¯†åº¦: <strong>${p.density.toLocaleString()}äºº/kmÂ²</strong></div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-face-smile"></i> æ„Ÿæƒ…åˆ†æ</div>
          <div class="info-item" style="margin-bottom:10px;">
            ä¸»è¦æ„Ÿæƒ…: <span style="color:${getEmotionColorForPopup(primaryEmotion, p.emotions[primaryEmotion])};font-weight:bold;font-size:14px;">
              ${capitalize(primaryEmotion)} (${p.analysis.intensity})
            </span>
          </div>
          ${Object.entries(p.emotions).map(([k,v])=>`
            <div class="emotion-score" style="margin-bottom:6px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>
              ${capitalize(k)}: <span style="font-weight:${k === primaryEmotion ? 'bold' : 'normal'}">${v}</span>
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-chart-bar"></i> äº‹æ¡ˆçµ±è¨ˆ</div>
          <div class="info-item">ç·äº‹æ¡ˆæ•°: <strong style="color:#06b6d4;">${p.incidents.total}ä»¶</strong></div>
          ${Object.entries(p.incidents).filter(([k]) => k !== 'total').map(([k,v])=>`
            <div class="info-item" style="font-size:11px;">
              <span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, 50)}"></span>
              ${capitalize(k)}: ${v}ä»¶
            </div>
          `).join('')}
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-location-dot"></i> ä¸»è¦æ–½è¨­</div>
          <div>${p.features.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-search"></i> è¦å› åˆ†æ</div>
          <div class="info-item">è¦å› : ${p.analysis.factors.map(f=>`<span class="feature-tag">${f}</span>`).join('')}</div>
        </div>
        
        <div class="info-box">
          <div class="info-title"><i class="fa-solid fa-lightbulb"></i> æ”¹å–„ææ¡ˆ</div>
          <div>${p.analysis.recommendations.map(r=>`<span class="feature-tag">${r}</span>`).join('')}</div>
        </div>
      `;
    }

    // ã‚¨ãƒªã‚¢é¸æŠ
    function selectArea(feature) {
      selectedArea = feature;
      updateDetailsPanel();
    }

    // çµ±è¨ˆãƒ‘ãƒãƒ«æ›´æ–°ï¼ˆè©³ç´°çµ±è¨ˆï¼‰
    function updateStatistics() {
      const statsPanel = document.getElementById('stats-panel');
      const filtered = sanoAzaGeoJSON.features.filter(f => {
        if (selectedEmotion === 'all') return true;
        return f.properties.analysis.primary === selectedEmotion;
      });
      
      const totalPop = filtered.reduce((sum,f)=>sum+f.properties.population,0);
      const totalArea = filtered.reduce((sum,f)=>sum+f.properties.area,0);
      const totalIncidents = filtered.reduce((sum,f)=>sum+f.properties.incidents.total,0);
      const avgDensity = filtered.length ? Math.round(totalPop / totalArea) : 0;
      
      const avgEmotions = { joy:0, calm:0, excitement:0, stress:0 };
      filtered.forEach(f=>{
        Object.keys(avgEmotions).forEach(k=>{
          avgEmotions[k] += f.properties.emotions[k];
        });
      });
      Object.keys(avgEmotions).forEach(k=>{
        avgEmotions[k] = filtered.length ? Math.round(avgEmotions[k]/filtered.length) : 0;
      });
      
      // å¼·åº¦åˆ¥é›†è¨ˆ
      const intensityCount = { 'ä½': 0, 'ä¸­': 0, 'é«˜': 0, 'éå¸¸ã«é«˜': 0 };
      filtered.forEach(f => {
        const intensity = f.properties.analysis.intensity;
        if (intensityCount[intensity] !== undefined) {
          intensityCount[intensity]++;
        }
      });
      
      statsPanel.innerHTML = `
        <div class="section-title"><i class="fa-solid fa-chart-pie"></i> çµ±è¨ˆæƒ…å ±</div>
        
        <div class="stat-item"><span class="stat-label">åŒºç”»æ•°</span><span class="stat-value">${filtered.length}</span></div>
        <div class="stat-item"><span class="stat-label">ç·äººå£</span><span class="stat-value">${totalPop.toLocaleString()}äºº</span></div>
        <div class="stat-item"><span class="stat-label">ç·é¢ç©</span><span class="stat-value">${totalArea}kmÂ²</span></div>
        <div class="stat-item"><span class="stat-label">å¹³å‡å¯†åº¦</span><span class="stat-value">${avgDensity.toLocaleString()}äºº/kmÂ²</span></div>
        <div class="stat-item"><span class="stat-label">ç·äº‹æ¡ˆæ•°</span><span class="stat-value" style="color:#f59e0b;">${totalIncidents}ä»¶</span></div>
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-face-smile"></i> æ„Ÿæƒ…ã‚¹ã‚³ã‚¢å¹³å‡
        </div>
        ${Object.entries(avgEmotions).map(([k,v])=>`
          <div class="stat-item">
            <span class="stat-label"><span class="emotion-indicator" style="background:${getEmotionColorForPopup(k, v)}"></span>${capitalize(k)}</span>
            <span class="stat-value">${v}</span>
          </div>
        `).join('')}
        
        <div style="margin:12px 0 8px 0; font-size:11px; color:#06b6d4; font-weight:bold;">
          <i class="fa-solid fa-signal"></i> å¼·åº¦åˆ†å¸ƒ
        </div>
        ${Object.entries(intensityCount).map(([intensity, count])=>`
          <div class="stat-item">
            <span class="stat-label">${intensity}</span>
            <span class="stat-value">${count}åŒºç”»</span>
          </div>
        `).join('')}
      `;
    }

    // æ„Ÿæƒ…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆæ›´æ–°ç‰ˆï¼‰
    function initializeControls() {
      const filterDiv = document.getElementById('emotion-filters');
      const emotions = [
        { key:'all', label:'å…¨è¡¨ç¤º', icon:'fa-layer-group' },
        { key:'joy', label:'Joy (å–œã³)', icon:'fa-face-smile' },
        { key:'calm', label:'Calm (å¹³é™)', icon:'fa-face-meh' },
        { key:'excitement', label:'Excitement (èˆˆå¥®)', icon:'fa-bolt' },
        { key:'stress', label:'Stress (ã‚¹ãƒˆãƒ¬ã‚¹)', icon:'fa-face-frown' }
      ];
      
      filterDiv.innerHTML = '';
      emotions.forEach(e=>{
        const btn = document.createElement('button');
        btn.className = 'emotion-btn' + (selectedEmotion===e.key?' active':'');
        btn.innerHTML = `<i class="fa-solid ${e.icon}"></i> ${e.label}`;
        btn.onclick = ()=>{
          selectedEmotion = e.key;
          // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã®activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          filterDiv.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('active'));
          // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          btn.classList.add('active');
          loadEmotionData();
          updateStatistics();
        };
        filterDiv.appendChild(btn);
      });
      
      // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('display-mode').onchange = function() {
        displayMode = this.value;
        loadEmotionData();
      };
      
      // ãƒ¬ã‚¤ãƒ¤ãƒ¼ON/OFF
      document.getElementById('layer-toggle').onclick = function() {
        showEmotionLayer = !showEmotionLayer;
        this.classList.toggle('active', showEmotionLayer);
        this.textContent = showEmotionLayer ? 'ON' : 'OFF';
        if (showEmotionLayer) loadEmotionData();
        else if (emotionLayer) map.removeLayer(emotionLayer);
      };
      
      // ãƒ©ãƒ™ãƒ«ON/OFF
      document.getElementById('label-toggle').onclick = function() {
        showLabels = !showLabels;
        this.classList.toggle('active', showLabels);
        this.textContent = showLabels ? 'ON' : 'OFF';
        loadEmotionData();
      };
      
      // é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
      document.getElementById('opacity-slider').oninput = function() {
        layerOpacity = parseFloat(this.value);
        loadEmotionData();
      };
    }

    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
    function updateTimestamp() {
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
      const h = now.getHours(), min = now.getMinutes(), s = now.getSeconds();
      document.getElementById('timestamp').textContent =
        `${y}å¹´${m}æœˆ${d}æ—¥ ${h.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    // ãƒ‡ãƒãƒƒã‚°ç”¨: ç¾åœ¨ã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ç¢ºèª
    window.debugCurrentData = () => {
      console.log('=== ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ ===');
      console.log('sanoAzaGeoJSON:', sanoAzaGeoJSON);
      if (sanoAzaGeoJSON && sanoAzaGeoJSON.features) {
        console.log('ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ•°:', sanoAzaGeoJSON.features.length);
        sanoAzaGeoJSON.features.forEach((feature, index) => {
          console.log(`${index + 1}. ${feature.properties.name}:`, 
            feature.geometry.type, 
            feature.geometry.coordinates.length, 'åº§æ¨™é…åˆ—');
        });
      } else {
        console.log('GeoJSONãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
      }
      
      if (emotionLayer) {
        console.log('åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼:', emotionLayer.getLayers().length, 'ãƒ¬ã‚¤ãƒ¤ãƒ¼');
      } else {
        console.log('åœ°å›³ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
      }
      console.log('=== ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³çµ‚äº† ===');
    };

    // æ–‡å­—åˆ—å…ˆé ­å¤§æ–‡å­—
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ DOMContentLoaded - åˆæœŸåŒ–é–‹å§‹');
      
      // æœªå‡¦ç†ã®JavaScriptã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
      window.addEventListener('error', function(e) {
        console.error('âŒ æœªå‡¦ç†ã‚¨ãƒ©ãƒ¼:', e.error);
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«:', e.filename);
        console.error('è¡Œ:', e.lineno);
      });
      
      // æœªå‡¦ç†ã®Promise rejectionã‚’ã‚­ãƒ£ãƒƒãƒ
      window.addEventListener('unhandledrejection', function(e) {
        console.error('âŒ æœªå‡¦ç†Promise reject:', e.reason);
      });
      
      try {
        initializeMap();
        initializeControls();
        updateStatistics();
        updateDetailsPanel();
        setInterval(updateTimestamp, 1000);
        console.log('âœ… åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    });
  </script>
  
  <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ -->
  <div style="position: fixed; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 4px; font-size: 11px; max-width: 300px; z-index: 1001;">
    <strong>ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</strong><br>
    å›½åœŸäº¤é€šçœã€Œå›½åœŸæ•°å€¤æƒ…å ±ï¼ˆè¡Œæ”¿åŒºåŸŸãƒ‡ãƒ¼ã‚¿ï¼‰ã€<br>
    æ”¿åºœçµ±è¨ˆã®ç·åˆçª“å£ï¼ˆe-Statï¼‰ã€Œä»¤å’Œ5å¹´å…¨å›½éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘åˆ¥é¢ç©èª¿ã€<br>
    OpenStreetMap contributors ã«ã‚ˆã‚‹åœ°å›³ã‚¿ã‚¤ãƒ«<br>
    <a href="https://nlftp.mlit.go.jp/ksj/" target="_blank" rel="noopener" style="color: #2563eb;">å›½åœŸæ•°å€¤æƒ…å ±ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹</a>
  </div>
</body>
</html>